{% extends "base.html" %}
{% block content %}
{% set parents = materials | selectattr('parent_id', 'none') | list %}
{% set sacs = parents | selectattr('node_type', 'equalto', 'container') | list %}
{% if error %}
  <p class="error">{{ error }}</p>
{% endif %}

<section class="card hero-card">
  <div class="page-header">
    <div>
      <p class="eyebrow">Bibliothèque</p>
      <h1 class="page-title">Gestion du matériel</h1>
      <p class="page-subtitle">Structurez vos sacs et lots pour les réutiliser sur chaque poste.</p>
    </div>
    <div class="page-actions">
      <button class="btn" type="button" id="jump-to-builder">Accéder au builder</button>
      <button class="btn secondary" type="button" data-action="open-root-modal">Nouveau materiel</button>
    </div>
  </div>
  <div class="stat-grid">
    <div class="stat-card">
      <span class="stat-label">Total référencé</span>
      <strong>{{ materials | length }}</strong>
      <span class="pill">Éléments</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Parents racine</span>
      <strong>{{ parents | length }}</strong>
      <span class="pill">Modèles</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Sacs prêts</span>
      <strong>{{ sacs | length }}</strong>
      <span class="pill ok">Utilisables</span>
    </div>
  </div>
</section>

<section class="card sacs-overview">
  <div class="builder-header">
    <div>
      <h2>Bibliothèque de sacs</h2>
      <p class="muted">
        Sélectionnez un sac existant pour reprendre sa structure ou lancez une nouvelle création.
      </p>
    </div>
    <div class="builder-header-actions">
      <button class="btn" type="button" data-action="open-root-modal">Nouveau materiel</button>
    </div>
  </div>
  <div class="sacs-grid">
    {% for item in materials if item.parent_id is none and item.node_type == 'container' %}
      <article class="sac-card" data-parent-id="{{ item.id }}">
        <div>
          <h3>{{ item.name }}</h3>
          <p class="muted">Checklist prête à être enrichie avec des compartiments et items.</p>
        </div>
        <div class="sac-card-actions">
          <button class="btn small secondary sac-open" type="button" data-parent-id="{{ item.id }}">
            Modifier
          </button>
          <form method="post" action="/materials/{{ item.id }}/delete" class="inline-form sac-action-form">
            <button
              type="submit"
              class="btn small danger"
              onclick="return confirm('Supprimer définitivement ce sac ?');"
            >
              Supprimer
            </button>
          </form>
        </div>
      </article>
    {% else %}
      <div class="sac-empty">
        <p class="muted">Aucun sac créé pour l'instant. Utilisez “Nouveau sac” pour démarrer.</p>
      </div>
    {% endfor %}
  </div>
</section>

<section class="card builder">
  <div class="builder-header">
    <div>
      <h2>Atelier de checklist</h2>
      <p class="muted">Construisez un arbre clair, avec une vue structurée et un panneau d’édition rapide.</p>
    </div>
  </div>
  <div class="builder-toolbar">
    <label>Sélection rapide
      <select id="existing-parent-select">
        <option value="">Choisir un sac de base</option>
        {% for item in materials %}
          {% if item.parent_id is none %}
            <option value="{{ item.id }}">{{ item.name }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </label>
    <div class="builder-toolbar-actions">
      <button class="btn secondary" type="button" id="load-parent">Charger la structure</button>
    </div>
  </div>
  <div class="builder-toolbar builder-toolbar--secondary">
    <div class="builder-toolbar-section">
      <h4>Export / import des parents</h4>
      <p class="muted">Sélectionnez des parents racine pour exporter une structure complète, puis réimportez-la.</p>
    </div>
    <div class="builder-toolbar-section">
      <button class="btn secondary small" type="button" id="select-all-parents">Tout sélectionner</button>
      <button class="btn secondary small" type="button" id="clear-all-parents">Tout désélectionner</button>
    </div>
    <div class="builder-toolbar-actions">
      <button class="btn" type="button" id="export-parents">Exporter les parents</button>
      <button class="btn secondary" type="button" id="import-parents">Importer les parents</button>
      <input type="file" id="parents-import-file" accept="application/json" hidden />
      <form method="post" action="/materials/parents/import" id="parents-import-form" class="hidden">
        <input type="hidden" name="items_payload" id="parents-import-payload" />
      </form>
    </div>
  </div>
  <div class="builder-items-grid" id="parents-selection-grid">
    {% for parent in parents %}
      <label class="builder-item-card">
        <input type="checkbox" class="parent-selector" value="{{ parent.id }}" />
        <div>
          <strong>{{ parent.name }}</strong>
          <p class="muted">
            Parent racine · {{ "Contenant" if parent.node_type == "container" else "Item" }}
            {% if parent.node_type == "item" %}
              · Qté {{ parent.expected_qty or 0 }}
            {% endif %}
          </p>
        </div>
      </label>
    {% else %}
      <p class="muted">Aucun parent racine disponible pour l’export.</p>
    {% endfor %}
  </div>
  <form method="post" action="/materials/wizard" id="builder-form">
    <input type="hidden" name="wizard_payload" id="builder_payload" />
    <div class="builder-grid">
      <div class="builder-canvas">
        <div class="builder-canvas-header">
          <div>
            <h3>Structure modulable</h3>
            <p class="muted">Cliquez un carré pour l’éditer. Les contenants accueillent d’autres carrés.</p>
          </div>
          <span class="builder-pill">Niveaux illimités</span>
        </div>
        <div class="builder-root" id="builder-root"></div>
        <p class="builder-empty muted" id="builder-empty">
          Créez un parent ou chargez un modèle existant pour démarrer.
        </p>
      </div>
      <aside class="builder-panel">
        <h3>Éditeur</h3>
        <p class="muted" id="builder-panel-empty">Sélectionnez un carré pour afficher ses détails.</p>
        <div class="builder-panel-form hidden" id="builder-panel-form">
          <label>Nom
            <input type="text" id="node-name" />
          </label>
          <label>Type
            <select id="node-type"></select>
          </label>
          <label>Quantité (item uniquement)
            <input type="number" id="node-qty" min="0" />
          </label>
          <label>Déplacer dans
            <select id="node-parent"></select>
          </label>
          <div class="builder-panel-actions">
            <button class="btn small" type="button" id="save-node">Enregistrer</button>
            <button class="btn small secondary" type="button" id="duplicate-node">Dupliquer</button>
            <button class="btn small danger" type="button" id="delete-node">Supprimer</button>
          </div>
          <div class="builder-divider"></div>
          <div class="builder-add-child">
            <h4>Ajouter un sous-élément</h4>
            <label>Nom
              <input type="text" id="child-name" placeholder="Nom du sous-élément" />
            </label>
            <label>Type
              <select id="child-type"></select>
            </label>
            <label>Quantité
              <input type="number" id="child-qty" min="0" placeholder="Qté (item)" />
            </label>
            <button class="btn small" type="button" id="add-child">Ajouter</button>
          </div>
        </div>
      </aside>
    </div>
    <div class="wizard-actions">
      <button type="submit" class="btn">Enregistrer la checklist</button>
      <button type="button" class="btn secondary" id="builder-reset">Remettre à zéro</button>
    </div>
  </form>
</section>

<dialog class="modal" id="root-modal">
  <div class="modal-card">
    <h3>Créer un parent</h3>
    <p class="muted">Exemples : Ambulance VSAV, Sac intervention, Poste de secours.</p>
    <label>Nom du parent
      <input type="text" id="root-name" placeholder="Nom du parent" />
    </label>
    <label>Type
      <select id="root-type">
        <option value="container">Sac (conteneur)</option>
        <option value="item">Item</option>
      </select>
    </label>
    <label id="root-qty-wrapper" class="hidden">Quantité (item uniquement)
      <input type="number" id="root-qty" min="0" placeholder="Qté (item)" />
    </label>
    <div class="modal-actions">
      <button class="btn secondary" type="button" onclick="document.getElementById('root-modal').close()">Annuler</button>
      <button class="btn" type="button" id="create-root">Créer</button>
    </div>
  </div>
</dialog>

<script>
  const existingMaterials = {{ materials_payload | tojson }};
  const builderState = {
    nodes: [],
    rootId: null,
    rootMaterialId: null,
    selectedId: null,
  };

  const rootSelect = document.getElementById("existing-parent-select");
  const loadParentButton = document.getElementById("load-parent");
  const openRootModalButtons = document.querySelectorAll('[data-action="open-root-modal"]');
  const sacsGrid = document.querySelector(".sacs-grid");
  const builderRoot = document.getElementById("builder-root");
  const builderEmpty = document.getElementById("builder-empty");
  const builderForm = document.getElementById("builder-form");
  const builderPayload = document.getElementById("builder_payload");
  const resetButton = document.getElementById("builder-reset");
  const jumpToBuilderButton = document.getElementById("jump-to-builder");
  const rootTypeSelect = document.getElementById("root-type");
  const rootQtyInput = document.getElementById("root-qty");
  const rootQtyWrapper = document.getElementById("root-qty-wrapper");
  const parentsSelectionGrid = document.getElementById("parents-selection-grid");
  const selectAllParentsButton = document.getElementById("select-all-parents");
  const clearAllParentsButton = document.getElementById("clear-all-parents");
  const exportParentsButton = document.getElementById("export-parents");
  const importParentsButton = document.getElementById("import-parents");
  const parentsImportFile = document.getElementById("parents-import-file");
  const parentsImportPayload = document.getElementById("parents-import-payload");
  const parentsImportForm = document.getElementById("parents-import-form");

  const panelEmpty = document.getElementById("builder-panel-empty");
  const panelForm = document.getElementById("builder-panel-form");
  const nodeNameInput = document.getElementById("node-name");
  const nodeTypeSelect = document.getElementById("node-type");
  const nodeQtyInput = document.getElementById("node-qty");
  const nodeParentSelect = document.getElementById("node-parent");
  const saveNodeButton = document.getElementById("save-node");
  const duplicateNodeButton = document.getElementById("duplicate-node");
  const deleteNodeButton = document.getElementById("delete-node");
  const childNameInput = document.getElementById("child-name");
  const childTypeSelect = document.getElementById("child-type");
  const childQtyInput = document.getElementById("child-qty");
  const addChildButton = document.getElementById("add-child");

  const normalizeLabel = (value) => value?.trim();
  const generateId = () => `node-${Date.now()}-${Math.random().toString(16).slice(2)}`;

  const materialMap = new Map();
  existingMaterials.forEach((material) => {
    materialMap.set(material.id, { ...material, children: [] });
  });
  existingMaterials.forEach((material) => {
    const parent = materialMap.get(material.parent_id);
    if (parent) {
      parent.children.push(materialMap.get(material.id));
    }
  });

  const findNode = (nodeId) => builderState.nodes.find((node) => node.id === nodeId);
  const getChildren = (parentId) => builderState.nodes.filter((node) => node.parentId === parentId);
  const getDepth = (nodeId) => {
    let depth = 0;
    let current = findNode(nodeId);
    while (current?.parentId) {
      depth += 1;
      current = findNode(current.parentId);
    }
    return depth;
  };
  const isDescendant = (nodeId, targetId) => {
    const children = getChildren(nodeId);
    for (const child of children) {
      if (child.id === targetId || isDescendant(child.id, targetId)) {
        return true;
      }
    }
    return false;
  };

  const resetBuilder = () => {
    builderState.nodes = [];
    builderState.rootId = null;
    builderState.rootMaterialId = null;
    builderState.selectedId = null;
    renderBuilder();
    renderPanel();
  };

  const createNode = ({ name, type, qty = null, parentId = null }) => {
    const node = {
      id: generateId(),
      name,
      type,
      qty: type === "item" ? qty ?? null : null,
      parentId,
    };
    builderState.nodes.push(node);
    return node;
  };

  const cloneTree = (materialNode, parentId = null) => {
    const node = createNode({
      name: materialNode.name,
      type: materialNode.node_type,
      qty: materialNode.expected_qty,
      parentId,
    });
    materialNode.children.forEach((child) => cloneTree(child, node.id));
    return node.id;
  };

  const clearDraftSac = () => {
    sacsGrid?.querySelectorAll("[data-draft-id]").forEach((card) => card.remove());
  };

  const addDraftSac = (name, draftId) => {
    if (!sacsGrid) {
      return;
    }
    clearDraftSac();
    const emptyState = sacsGrid.querySelector(".sac-empty");
    if (emptyState) {
      emptyState.remove();
    }
    const card = document.createElement("article");
    card.className = "sac-card";
    card.dataset.draftId = draftId;
    card.innerHTML = `
      <div>
        <h3>${name}</h3>
        <p class="muted">Sac en cours de création. Sélectionnez-le pour continuer la configuration.</p>
      </div>
      <button class="btn small secondary sac-open" type="button" data-draft-id="${draftId}">
        Reprendre le sac
      </button>
    `;
    sacsGrid.prepend(card);
  };

  const setRoot = (name, type, qty) => {
    const root = createNode({ name, type, qty, parentId: null });
    builderState.rootId = root.id;
    builderState.selectedId = root.id;
    renderBuilder();
    renderPanel();
  };

  const renderNode = (node) => {
    const depth = getDepth(node.id);
    const nodeEl = document.createElement("div");
    nodeEl.className = `builder-node builder-node--${node.type}`;
    if (builderState.selectedId === node.id) {
      nodeEl.classList.add("active");
    }
    nodeEl.dataset.nodeId = node.id;

    const header = document.createElement("div");
    header.className = "builder-node-header";
    const title = document.createElement("div");
    title.innerHTML = `
      <strong>${node.name}</strong>
      <span class="builder-meta">${node.type === "container" ? "Contenant" : "Item"} · Niveau ${depth}</span>
    `;
    const badge = document.createElement("span");
    badge.className = "builder-pill";
    badge.textContent = node.type === "container" ? "Contenant" : `Item${node.qty !== null ? ` · Qté ${node.qty}` : ""}`;
    header.appendChild(title);
    header.appendChild(badge);

    const childrenWrap = document.createElement("div");
    childrenWrap.className = "builder-children";
    const children = getChildren(node.id);
    if (!children.length) {
      const empty = document.createElement("p");
      empty.className = "muted builder-child-empty";
      empty.textContent = node.type === "container" ? "Ajoutez un sous-élément depuis l’éditeur." : "Item sans sous-niveau.";
      childrenWrap.appendChild(empty);
    } else {
      children.forEach((child) => childrenWrap.appendChild(renderNode(child)));
    }

    nodeEl.appendChild(header);
    nodeEl.appendChild(childrenWrap);
    nodeEl.addEventListener("click", (event) => {
      event.stopPropagation();
      builderState.selectedId = node.id;
      renderBuilder();
      renderPanel();
    });
    return nodeEl;
  };

  const renderBuilder = () => {
    builderRoot.innerHTML = "";
    if (!builderState.rootId) {
      builderEmpty.classList.remove("hidden");
      return;
    }
    builderEmpty.classList.add("hidden");
    const rootNode = findNode(builderState.rootId);
    if (rootNode) {
      builderRoot.appendChild(renderNode(rootNode));
    }
  };

  const renderNodeTypeOptions = (select, allowedTypes, current) => {
    select.innerHTML = "";
    allowedTypes.forEach((type) => {
      const option = document.createElement("option");
      option.value = type;
      option.textContent = type === "container" ? "Contenant" : "Item";
      if (type === current) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  };

  const renderParentOptions = (node) => {
    nodeParentSelect.innerHTML = "";
    const rootOption = document.createElement("option");
    rootOption.value = "";
    rootOption.textContent = "Racine";
    nodeParentSelect.appendChild(rootOption);

    builderState.nodes
      .filter((candidate) => candidate.type === "container")
      .forEach((candidate) => {
        if (candidate.id === node.id) {
          return;
        }
        if (isDescendant(node.id, candidate.id)) {
          return;
        }
        const depth = getDepth(candidate.id);
        const option = document.createElement("option");
        option.value = candidate.id;
        option.textContent = `${candidate.name} (niveau ${depth})`;
        if (candidate.id === node.parentId) {
          option.selected = true;
        }
        nodeParentSelect.appendChild(option);
      });
  };

  const renderPanel = () => {
    if (!builderState.selectedId) {
      panelEmpty.classList.remove("hidden");
      panelForm.classList.add("hidden");
      return;
    }
    const node = findNode(builderState.selectedId);
    if (!node) {
      panelEmpty.classList.remove("hidden");
      panelForm.classList.add("hidden");
      return;
    }
    panelEmpty.classList.add("hidden");
    panelForm.classList.remove("hidden");

    const existingChildren = getChildren(node.id);
    const allowedTypes = existingChildren.length ? ["container"] : ["container", "item"];
    renderNodeTypeOptions(nodeTypeSelect, allowedTypes, node.type);

    nodeNameInput.value = node.name;
    nodeQtyInput.value = node.qty ?? "";
    nodeQtyInput.disabled = node.type !== "item";
    renderParentOptions(node);

    duplicateNodeButton.disabled = node.id === builderState.rootId;
    deleteNodeButton.disabled = node.id === builderState.rootId;

    nodeTypeSelect.disabled = existingChildren.length > 0;

    const childAllowedTypes = ["container", "item"];
    renderNodeTypeOptions(childTypeSelect, childAllowedTypes, childAllowedTypes[0]);
    childQtyInput.disabled = childTypeSelect.value !== "item";
    childNameInput.value = "";
    childQtyInput.value = "";
  };

  const addChild = () => {
    const parent = findNode(builderState.selectedId);
    if (!parent || parent.type !== "container") {
      return;
    }
    const name = normalizeLabel(childNameInput.value);
    if (!name) {
      return;
    }
    const type = childTypeSelect.value;
    const qty = type === "item" && childQtyInput.value !== "" ? Number(childQtyInput.value) : null;
    createNode({ name, type, qty, parentId: parent.id });
    childNameInput.value = "";
    childQtyInput.value = "";
    renderBuilder();
    renderPanel();
  };

  saveNodeButton.addEventListener("click", () => {
    const node = findNode(builderState.selectedId);
    if (!node) {
      return;
    }
    const name = normalizeLabel(nodeNameInput.value);
    if (!name) {
      return;
    }
    node.name = name;
    node.type = nodeTypeSelect.value;
    node.qty = node.type === "item" && nodeQtyInput.value !== "" ? Number(nodeQtyInput.value) : null;
    const newParent = nodeParentSelect.value || null;
    if (node.id === builderState.rootId && newParent) {
      return;
    }
    if (newParent !== node.parentId) {
      node.parentId = newParent;
      if (!newParent) {
        builderState.rootId = node.id;
      }
    }
    renderBuilder();
    renderPanel();
  });

  duplicateNodeButton.addEventListener("click", () => {
    const node = findNode(builderState.selectedId);
    if (!node || node.id === builderState.rootId) {
      return;
    }
    const cloneSubtree = (source, parentId) => {
      const newNode = createNode({
        name: `${source.name} (copie)`,
        type: source.type,
        qty: source.qty,
        parentId,
      });
      getChildren(source.id).forEach((child) => cloneSubtree(child, newNode.id));
      return newNode.id;
    };
    cloneSubtree(node, node.parentId);
    renderBuilder();
    renderPanel();
  });

  deleteNodeButton.addEventListener("click", () => {
    const node = findNode(builderState.selectedId);
    if (!node || node.id === builderState.rootId) {
      return;
    }
    const removeNode = (nodeId) => {
      getChildren(nodeId).forEach((child) => removeNode(child.id));
      builderState.nodes = builderState.nodes.filter((item) => item.id !== nodeId);
    };
    removeNode(node.id);
    builderState.selectedId = null;
    renderBuilder();
    renderPanel();
  });

  addChildButton.addEventListener("click", addChild);
  childTypeSelect.addEventListener("change", () => {
    childQtyInput.disabled = childTypeSelect.value !== "item";
  });
  nodeTypeSelect.addEventListener("change", () => {
    nodeQtyInput.disabled = nodeTypeSelect.value !== "item";
    const node = findNode(builderState.selectedId);
    if (node) {
      renderParentOptions(node);
    }
  });

  loadParentButton.addEventListener("click", () => {
    const selectedId = Number(rootSelect.value);
    if (!selectedId) {
      return;
    }
    const material = materialMap.get(selectedId);
    if (!material) {
      return;
    }
    resetBuilder();
    builderState.rootId = cloneTree(material, null);
    builderState.rootMaterialId = selectedId;
    builderState.selectedId = builderState.rootId;
    renderBuilder();
    renderPanel();
  });

  sacsGrid?.addEventListener("click", (event) => {
    const button = event.target.closest(".sac-open");
    if (!button) {
      return;
    }
    const draftId = button.dataset.draftId;
    if (draftId) {
      builderState.selectedId = builderState.rootId;
      renderBuilder();
      renderPanel();
      builderRoot.scrollIntoView({ behavior: "smooth", block: "start" });
      nodeNameInput.focus();
      return;
    }
    const selectedId = Number(button.dataset.parentId);
    if (!selectedId) {
      return;
    }
    rootSelect.value = selectedId;
    loadParentButton.click();
    builderRoot.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  const toggleRootQty = () => {
    const isItem = rootTypeSelect.value === "item";
    rootQtyWrapper.classList.toggle("hidden", !isItem);
    rootQtyInput.disabled = !isItem;
  };

  rootTypeSelect.addEventListener("change", toggleRootQty);

  openRootModalButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const modal = document.getElementById("root-modal");
      toggleRootQty();
      modal.showModal();
    });
  });

  jumpToBuilderButton?.addEventListener("click", () => {
    builderRoot.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  document.getElementById("create-root").addEventListener("click", () => {
    const input = document.getElementById("root-name");
    const name = normalizeLabel(input.value);
    if (!name) {
      return;
    }
    const rootType = rootTypeSelect.value;
    const rootQty = rootType === "item" && rootQtyInput.value !== "" ? Number(rootQtyInput.value) : null;
    resetBuilder();
    setRoot(name, rootType, rootQty);
    builderState.rootMaterialId = null;
    addDraftSac(name, builderState.rootId);
    nodeNameInput.focus();
    input.value = "";
    rootQtyInput.value = "";
    document.getElementById("root-modal").close();
  });

  resetButton.addEventListener("click", resetBuilder);

  const getSelectedParentIds = () =>
    Array.from(document.querySelectorAll(".parent-selector:checked")).map((input) => input.value);

  selectAllParentsButton?.addEventListener("click", () => {
    document.querySelectorAll(".parent-selector").forEach((input) => {
      input.checked = true;
    });
  });

  clearAllParentsButton?.addEventListener("click", () => {
    document.querySelectorAll(".parent-selector").forEach((input) => {
      input.checked = false;
    });
  });

  exportParentsButton?.addEventListener("click", () => {
    const selectedIds = getSelectedParentIds();
    if (!selectedIds.length) {
      return;
    }
    const query = new URLSearchParams({ ids: selectedIds.join(",") });
    window.location.href = `/materials/parents/export?${query.toString()}`;
  });

  importParentsButton?.addEventListener("click", () => {
    parentsImportFile?.click();
  });

  parentsImportFile?.addEventListener("change", () => {
    const file = parentsImportFile.files?.[0];
    if (!file) {
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      const text = reader.result;
      if (typeof text !== "string") {
        return;
      }
      parentsImportPayload.value = text;
      parentsImportForm?.submit();
    };
    reader.readAsText(file);
  });

  builderForm.addEventListener("submit", (event) => {
    if (!builderState.rootId) {
      event.preventDefault();
      return;
    }
    const root = findNode(builderState.rootId);
    const rootChildren = getChildren(root.id);
    if (!rootChildren.length && root.type === "container") {
      event.preventDefault();
      return;
    }
    const serializeNode = (node) => ({
      name: node.name,
      type: node.type,
      qty: node.qty,
      children: getChildren(node.id).map((child) => serializeNode(child)),
    });
    const payload = {
      root: serializeNode(root),
    };
    if (builderState.rootMaterialId) {
      payload.root_id = builderState.rootMaterialId;
    }
    builderPayload.value = JSON.stringify(payload);
  });

  renderBuilder();
  renderPanel();
</script>
{% endblock %}
