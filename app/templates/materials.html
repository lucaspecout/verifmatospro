{% extends "base.html" %}
{% block content %}
{% set parents = materials | selectattr('parent_id', 'none') | list %}
{% set sacs = parents | selectattr('node_type', 'equalto', 'container') | list %}
{% if error %}
  <p class="error">{{ error }}</p>
{% endif %}

<section class="card hero-card">
  <div class="page-header">
    <div>
      <p class="eyebrow">Bibliothèque</p>
      <h1 class="page-title">Gestion du matériel</h1>
      <p class="page-subtitle">Structurez vos sacs et lots pour les réutiliser sur chaque poste.</p>
    </div>
    <div class="page-actions">
      <button class="btn" type="button" id="jump-to-builder">Accéder au builder</button>
      <button class="btn secondary" type="button" data-action="open-root-modal">Nouveau materiel</button>
      <button class="btn secondary" type="button" data-action="trigger-import">Importer</button>
    </div>
  </div>
  <div class="stat-grid">
    <div class="stat-card">
      <span class="stat-label">Total référencé</span>
      <strong>{{ materials | length }}</strong>
      <span class="pill">Éléments</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Parents racine</span>
      <strong>{{ parents | length }}</strong>
      <span class="pill">Modèles</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Sacs prêts</span>
      <strong>{{ sacs | length }}</strong>
      <span class="pill ok">Utilisables</span>
    </div>
  </div>
</section>

<section class="card sacs-overview">
  <div class="builder-header">
    <div>
      <h2>Bibliothèque de sacs</h2>
      <p class="muted">
        Sélectionnez un sac existant pour reprendre sa structure ou lancez une nouvelle création.
      </p>
    </div>
    <div class="builder-header-actions">
      <button class="btn" type="button" data-action="open-root-modal">Nouveau materiel</button>
      <button class="btn secondary" type="button" data-action="trigger-import">Importer</button>
    </div>
  </div>
  <div class="sacs-grid">
    {% for item in materials if item.parent_id is none and item.node_type == 'container' %}
      <article class="sac-card" data-parent-id="{{ item.id }}">
        <div>
          <h3>{{ item.name }}</h3>
          <p class="muted">Checklist prête à être enrichie avec des compartiments et items.</p>
        </div>
        <div class="sac-card-actions">
          <button class="btn small secondary sac-open" type="button" data-parent-id="{{ item.id }}">
            Modifier
          </button>
          <button
            class="btn small secondary"
            type="button"
            data-action="open-duplicate-modal"
            data-parent-id="{{ item.id }}"
            data-parent-name="{{ item.name }}"
          >
            Dupliquer
          </button>
          <a class="btn small secondary" href="/materials/parents/export?ids={{ item.id }}">
            Exporter
          </a>
          <form method="post" action="/materials/{{ item.id }}/delete" class="inline-form sac-action-form">
            <button
              type="submit"
              class="btn small danger"
              onclick="return confirm('Supprimer définitivement ce sac ?');"
            >
              Supprimer
            </button>
          </form>
        </div>
      </article>
    {% else %}
      <div class="sac-empty">
        <p class="muted">Aucun sac créé pour l'instant. Utilisez “Nouveau sac” pour démarrer.</p>
      </div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <div class="builder-header">
    <div>
      <h2>Lots de matériel</h2>
      <p class="muted">Regroupez plusieurs sacs dans un lot pour les ajouter en un clic lors de la création d'un poste.</p>
    </div>
  </div>
  <form method="post" action="/lots" class="form">
    <label>Nom du lot
      <input type="text" name="name" placeholder="Exemple : Lot rouge" required />
    </label>
    <label>Sacs inclus
      <select name="template_ids" multiple>
        {% for template in root_templates %}
        <option value="{{ template.id }}">{{ template.name }}</option>
        {% endfor %}
      </select>
      <span class="help-text">Ajoutez uniquement des sacs parents (racine).</span>
    </label>
    <button type="submit" class="btn">Créer le lot</button>
  </form>
  <div class="sacs-grid">
    {% for lot in lots %}
      <article class="sac-card lot-card" data-lot-id="{{ lot.id }}">
        <div class="lot-card-header">
          <div>
            <h3>{{ lot.name }}</h3>
            <p class="muted">{{ lot.materials | length }} sac(s) inclus</p>
          </div>
        </div>
        <ul class="lot-card-list">
          {% for template in lot.materials %}
            <li>{{ template.name }}</li>
          {% else %}
            <li class="muted">Aucun sac associé pour le moment.</li>
          {% endfor %}
        </ul>
        <div class="sac-card-actions">
          <button
            class="btn small secondary"
            type="button"
            data-action="toggle-lot-form"
            data-lot-id="{{ lot.id }}"
          >
            Modifier
          </button>
          <form method="post" action="/lots/{{ lot.id }}/delete" class="inline-form sac-action-form">
            <button
              type="submit"
              class="btn small danger"
              onclick="return confirm('Supprimer définitivement ce lot ?');"
            >
              Supprimer
            </button>
          </form>
        </div>
        <form
          method="post"
          action="/lots/{{ lot.id }}"
          class="form lot-edit-form"
          id="lot-form-{{ lot.id }}"
          data-lot-id="{{ lot.id }}"
          hidden
        >
          <label>Nom du lot
            <input type="text" name="name" value="{{ lot.name }}" required />
          </label>
          <label>Sacs inclus
            <select name="template_ids" multiple>
              {% for template in root_templates %}
              <option
                value="{{ template.id }}"
                {% if template in lot.materials %}selected{% endif %}
              >
                {{ template.name }}
              </option>
              {% endfor %}
            </select>
          </label>
          <div class="sac-card-actions">
            <button class="btn small" type="submit">Enregistrer</button>
            <button class="btn small secondary" type="button" data-action="close-lot-form">
              Annuler
            </button>
          </div>
        </form>
      </article>
    {% else %}
      <div class="sac-empty">
        <p class="muted">Aucun lot créé. Utilisez le formulaire ci-dessus pour en ajouter.</p>
      </div>
    {% endfor %}
  </div>
</section>

<section class="card builder">
  <form method="post" action="/materials/wizard" id="builder-form">
    <input type="hidden" name="wizard_payload" id="builder_payload" />
    <div class="builder-grid">
      <div class="builder-canvas">
        <div class="builder-canvas-header">
          <div>
            <h3>Structure modulable</h3>
            <p class="muted">Cliquez un carré pour l’éditer. Les contenants accueillent d’autres carrés.</p>
          </div>
          <div class="builder-canvas-meta">
            <span class="builder-count-pill" id="builder-count">0 item</span>
            <span class="builder-pill">Niveaux illimités</span>
          </div>
        </div>
        <div class="builder-root builder-visual" id="builder-root"></div>
        <p class="builder-empty muted" id="builder-empty">
          Créez un parent ou chargez un modèle existant pour démarrer.
        </p>
      </div>
    </div>
    <div class="builder-actions">
      <button class="btn" type="submit">Enregistrer</button>
    </div>
  </form>
</section>

<input type="file" id="parents-import-file" accept="application/json" hidden />
<form method="post" action="/materials/parents/import" id="parents-import-form" class="hidden">
  <input type="hidden" name="items_payload" id="parents-import-payload" />
</form>

<dialog class="modal" id="root-modal">
  <div class="modal-card">
    <h3>Créer un parent</h3>
    <p class="muted">Exemples : Ambulance VSAV, Sac intervention, Poste de secours.</p>
    <label>Nom du parent
      <input type="text" id="root-name" placeholder="Nom du parent" />
    </label>
    <label>Type
      <select id="root-type">
        <option value="container">Sac (conteneur)</option>
        <option value="item">Item</option>
      </select>
    </label>
    <label id="root-qty-wrapper" class="hidden">Quantité (item uniquement)
      <input type="number" id="root-qty" min="0" placeholder="Qté (item)" />
    </label>
    <div class="modal-actions">
      <button class="btn secondary" type="button" id="root-modal-cancel">Annuler</button>
      <button class="btn" type="button" id="create-root">Créer</button>
    </div>
  </div>
</dialog>

<dialog class="modal" id="node-modal">
  <div class="modal-card">
    <h3 id="node-modal-title">Modifier un élément</h3>
    <div id="node-modal-edit">
      <label>Nom
        <input type="text" id="node-name" />
      </label>
      <label>Type
        <select id="node-type"></select>
      </label>
      <label>Quantité (item uniquement)
        <input type="number" id="node-qty" min="0" />
      </label>
      <label>Déplacer dans
        <select id="node-parent"></select>
      </label>
    </div>
    <div id="node-modal-add" class="hidden">
      <label>Nom
        <input type="text" id="child-name" placeholder="Nom du sous-élément" />
      </label>
      <label>Type
        <select id="child-type"></select>
      </label>
      <label>Quantité
        <input type="number" id="child-qty" min="0" placeholder="Qté (item)" />
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn secondary" type="button" id="node-modal-cancel">Annuler</button>
      <button class="btn" type="button" id="save-node">Enregistrer</button>
      <button class="btn secondary" type="button" id="duplicate-node">Dupliquer</button>
      <button class="btn danger" type="button" id="delete-node">Supprimer</button>
      <button class="btn" type="button" id="add-child">Ajouter</button>
    </div>
  </div>
</dialog>

<dialog class="modal" id="duplicate-modal">
  <form method="post" action="/materials/parents/duplicate" class="modal-card">
    <h3>Dupliquer un parent</h3>
    <p class="muted">Choisissez le nom du nouveau sac avant de copier la structure.</p>
    <input type="hidden" name="source_id" id="duplicate-source-id" />
    <label>Nom du parent
      <input type="text" name="name" id="duplicate-name" placeholder="Nom du parent" required />
    </label>
    <div class="modal-actions">
      <button class="btn secondary" type="button" id="duplicate-modal-cancel">Annuler</button>
      <button class="btn" type="submit">Dupliquer</button>
    </div>
  </form>
</dialog>

<script>
  const existingMaterials = {{ materials_payload | tojson }};
  const builderState = {
    nodes: [],
    rootId: null,
    rootMaterialId: null,
    selectedId: null,
  };

  const openRootModalButtons = document.querySelectorAll('[data-action="open-root-modal"]');
  const sacsGrid = document.querySelector(".sacs-grid");
  const builderRoot = document.getElementById("builder-root");
  const builderCount = document.getElementById("builder-count");
  const builderEmpty = document.getElementById("builder-empty");
  const builderForm = document.getElementById("builder-form");
  const builderPayload = document.getElementById("builder_payload");
  const jumpToBuilderButton = document.getElementById("jump-to-builder");
  const rootTypeSelect = document.getElementById("root-type");
  const rootQtyInput = document.getElementById("root-qty");
  const rootQtyWrapper = document.getElementById("root-qty-wrapper");
  const importParentsButtons = document.querySelectorAll('[data-action="trigger-import"]');
  const parentsImportFile = document.getElementById("parents-import-file");
  const parentsImportPayload = document.getElementById("parents-import-payload");
  const parentsImportForm = document.getElementById("parents-import-form");
  const lotToggleButtons = document.querySelectorAll('[data-action="toggle-lot-form"]');
  const lotCloseButtons = document.querySelectorAll('[data-action="close-lot-form"]');

  const nodeModal = document.getElementById("node-modal");
  const nodeModalTitle = document.getElementById("node-modal-title");
  const nodeModalEdit = document.getElementById("node-modal-edit");
  const nodeModalAdd = document.getElementById("node-modal-add");
  const nodeModalCancel = document.getElementById("node-modal-cancel");
  const rootModalCancel = document.getElementById("root-modal-cancel");
  const duplicateModal = document.getElementById("duplicate-modal");
  const duplicateModalCancel = document.getElementById("duplicate-modal-cancel");
  const duplicateSourceIdInput = document.getElementById("duplicate-source-id");
  const duplicateNameInput = document.getElementById("duplicate-name");
  const nodeNameInput = document.getElementById("node-name");
  const nodeTypeSelect = document.getElementById("node-type");
  const nodeQtyInput = document.getElementById("node-qty");
  const nodeParentSelect = document.getElementById("node-parent");
  const saveNodeButton = document.getElementById("save-node");
  const duplicateNodeButton = document.getElementById("duplicate-node");
  const deleteNodeButton = document.getElementById("delete-node");
  const childNameInput = document.getElementById("child-name");
  const childTypeSelect = document.getElementById("child-type");
  const childQtyInput = document.getElementById("child-qty");
  const addChildButton = document.getElementById("add-child");

  const normalizeLabel = (value) => value?.trim();
  const generateId = () => `node-${Date.now()}-${Math.random().toString(16).slice(2)}`;
  const openDialog = (dialog) => {
    if (!dialog) {
      return;
    }
    if (typeof dialog.showModal === "function" && !dialog.open) {
      dialog.showModal();
    }
    dialog.setAttribute("open", "");
    dialog.classList.add("is-open");
  };
  const closeDialog = (dialog) => {
    if (!dialog) {
      return;
    }
    if (typeof dialog.close === "function" && dialog.open) {
      dialog.close();
    }
    dialog.classList.remove("is-open");
    dialog.removeAttribute("open");
  };

  const materialMap = new Map();
  existingMaterials.forEach((material) => {
    materialMap.set(material.id, { ...material, children: [] });
  });
  existingMaterials.forEach((material) => {
    const parent = materialMap.get(material.parent_id);
    if (parent) {
      parent.children.push(materialMap.get(material.id));
    }
  });

  const findNode = (nodeId) => builderState.nodes.find((node) => node.id === nodeId);
  const getChildren = (parentId) => builderState.nodes.filter((node) => node.parentId === parentId);
  const selectNode = (nodeId) => {
    builderState.selectedId = nodeId;
    renderBuilder();
  };
  const getDepth = (nodeId) => {
    let depth = 0;
    let current = findNode(nodeId);
    while (current?.parentId) {
      depth += 1;
      current = findNode(current.parentId);
    }
    return depth;
  };
  const isDescendant = (nodeId, targetId) => {
    const children = getChildren(nodeId);
    for (const child of children) {
      if (child.id === targetId || isDescendant(child.id, targetId)) {
        return true;
      }
    }
    return false;
  };
  const getSubtreeStats = (nodeId) => {
    let items = 0;
    let containers = 0;
    const walk = (currentId) => {
      getChildren(currentId).forEach((child) => {
        if (child.type === "item") {
          items += 1;
        } else {
          containers += 1;
          walk(child.id);
        }
      });
    };
    walk(nodeId);
    return { items, containers };
  };
  const removeNode = (nodeId) => {
    getChildren(nodeId).forEach((child) => removeNode(child.id));
    builderState.nodes = builderState.nodes.filter((item) => item.id !== nodeId);
  };
  const deleteNodeById = (nodeId) => {
    if (nodeId === builderState.rootId) {
      return;
    }
    removeNode(nodeId);
    if (builderState.selectedId === nodeId) {
      builderState.selectedId = null;
    }
    renderBuilder();
  };

  const resetBuilder = () => {
    builderState.nodes = [];
    builderState.rootId = null;
    builderState.rootMaterialId = null;
    builderState.selectedId = null;
    renderBuilder();
  };

  const createNode = ({ name, type, qty = null, parentId = null }) => {
    const node = {
      id: generateId(),
      name,
      type,
      qty: type === "item" ? qty ?? null : null,
      parentId,
    };
    builderState.nodes.push(node);
    return node;
  };

  const cloneTree = (materialNode, parentId = null) => {
    const node = createNode({
      name: materialNode.name,
      type: materialNode.node_type,
      qty: materialNode.expected_qty,
      parentId,
    });
    materialNode.children.forEach((child) => cloneTree(child, node.id));
    return node.id;
  };

  const clearDraftSac = () => {
    sacsGrid?.querySelectorAll("[data-draft-id]").forEach((card) => card.remove());
  };

  const addDraftSac = (name, draftId) => {
    if (!sacsGrid) {
      return;
    }
    clearDraftSac();
    const emptyState = sacsGrid.querySelector(".sac-empty");
    if (emptyState) {
      emptyState.remove();
    }
    const card = document.createElement("article");
    card.className = "sac-card";
    card.dataset.draftId = draftId;
    card.innerHTML = `
      <div>
        <h3>${name}</h3>
        <p class="muted">Sac en cours de création. Sélectionnez-le pour continuer la configuration.</p>
      </div>
      <button class="btn small secondary sac-open" type="button" data-draft-id="${draftId}">
        Reprendre le sac
      </button>
    `;
    sacsGrid.prepend(card);
  };

  const setRoot = (name, type, qty) => {
    const root = createNode({ name, type, qty, parentId: null });
    builderState.rootId = root.id;
    builderState.selectedId = root.id;
    renderBuilder();
  };

  const openNodeModal = ({ mode, nodeId }) => {
    const node = findNode(nodeId);
    if (!node) {
      return;
    }
    builderState.selectedId = nodeId;
    renderBuilder();

    if (mode === "add" && node.type !== "container") {
      return;
    }

    const isAddMode = mode === "add";
    nodeModalTitle.textContent = isAddMode ? "Ajouter un sous-élément" : "Modifier un élément";
    nodeModalEdit.classList.toggle("hidden", isAddMode);
    nodeModalAdd.classList.toggle("hidden", !isAddMode);
    saveNodeButton.classList.toggle("hidden", isAddMode);
    duplicateNodeButton.classList.toggle("hidden", isAddMode);
    deleteNodeButton.classList.toggle("hidden", isAddMode);
    addChildButton.classList.toggle("hidden", !isAddMode);

    if (isAddMode) {
      const childAllowedTypes = ["container", "item"];
      renderNodeTypeOptions(childTypeSelect, childAllowedTypes, childAllowedTypes[0]);
      childQtyInput.disabled = childTypeSelect.value !== "item";
      childNameInput.value = "";
      childQtyInput.value = "";
    } else {
      const existingChildren = getChildren(node.id);
      const allowedTypes = existingChildren.length ? ["container"] : ["container", "item"];
      renderNodeTypeOptions(nodeTypeSelect, allowedTypes, node.type);

      nodeNameInput.value = node.name;
      nodeQtyInput.value = node.qty ?? "";
      nodeQtyInput.disabled = node.type !== "item";
      renderParentOptions(node);

      duplicateNodeButton.disabled = node.id === builderState.rootId;
      deleteNodeButton.disabled = node.id === builderState.rootId;
      nodeTypeSelect.disabled = existingChildren.length > 0;
    }

    openDialog(nodeModal);
    if (isAddMode) {
      childNameInput.focus();
    } else {
      nodeNameInput.focus();
    }
  };

  const renderNode = (node) => {
    const createActionButton = (label, variant, action) => {
      const button = document.createElement("button");
      button.type = "button";
      button.className = `btn small ${variant}`;
      button.textContent = label;
      button.dataset.action = action;
      button.addEventListener("click", (event) => {
        event.stopPropagation();
        if (action === "edit") {
          openNodeModal({ mode: "edit", nodeId: node.id });
        }
        if (action === "add") {
          openNodeModal({ mode: "add", nodeId: node.id });
        }
        if (action === "delete") {
          if (confirm("Supprimer cet élément ?")) {
            deleteNodeById(node.id);
          }
        }
      });
      return button;
    };

    if (node.type === "container") {
      const stats = getSubtreeStats(node.id);
      const details = document.createElement("details");
      details.className = "checklist-section builder-section";
      if (builderState.selectedId === node.id) {
        details.classList.add("active");
      }
      details.open = true;
      details.dataset.nodeId = node.id;
      details.dataset.nodeType = node.type;

      const summary = document.createElement("summary");
      summary.className = "checklist-section-header builder-section-header";
      summary.addEventListener("click", (event) => {
        if (event.target.closest(".builder-node-actions")) {
          return;
        }
        selectNode(node.id);
      });

      const titleWrap = document.createElement("div");
      const subtitleParts = [
        `${stats.containers} sous-sac${stats.containers > 1 ? "s" : ""}`,
        `${stats.items} item${stats.items > 1 ? "s" : ""}`,
      ];
      titleWrap.innerHTML = `
        <h2>${node.name}</h2>
        <p class="section-subtitle">${subtitleParts.join(" · ")}</p>
      `;

      const countPill = document.createElement("span");
      countPill.className = "builder-count-pill";
      countPill.textContent = `${stats.items} item${stats.items > 1 ? "s" : ""}`;

      const actions = document.createElement("div");
      actions.className = "builder-node-actions";
      actions.appendChild(createActionButton("Modifier", "ghost", "edit"));
      actions.appendChild(createActionButton("Ajouter", "secondary", "add"));
      if (node.id !== builderState.rootId) {
        actions.appendChild(createActionButton("Supprimer", "danger", "delete"));
      }

      summary.appendChild(titleWrap);
      summary.appendChild(countPill);
      summary.appendChild(actions);
      details.appendChild(summary);

      const childrenWrap = document.createElement("div");
      childrenWrap.className = "checklist-section-body";
      const children = getChildren(node.id);
      if (!children.length) {
        const empty = document.createElement("p");
        empty.className = "muted builder-child-empty";
        empty.textContent = "Ajoutez un sous-élément via le bouton “Ajouter”.";
        childrenWrap.appendChild(empty);
      } else {
        children.forEach((child) => childrenWrap.appendChild(renderNode(child)));
      }
      details.appendChild(childrenWrap);
      return details;
    }

    const item = document.createElement("div");
    item.className = "checklist-item builder-item";
    if (builderState.selectedId === node.id) {
      item.classList.add("active");
    }
    item.dataset.nodeId = node.id;
    item.dataset.nodeType = node.type;

    const row = document.createElement("div");
    row.className = "checklist-item-row";
    const info = document.createElement("div");
    info.className = "checklist-item-info";
    info.innerHTML = `
      <div class="checklist-item-name">
        <strong>${node.name}</strong>
      </div>
      <span class="qty">Attendu: ${node.qty ?? "-"}</span>
    `;

    const actions = document.createElement("div");
    actions.className = "builder-node-actions";
    actions.appendChild(createActionButton("Modifier", "ghost", "edit"));
    actions.appendChild(createActionButton("Supprimer", "danger", "delete"));

    row.appendChild(info);
    row.appendChild(actions);
    item.appendChild(row);
    item.addEventListener("click", (event) => {
      if (event.target.closest(".builder-node-actions")) {
        return;
      }
      selectNode(node.id);
    });
    return item;
  };

  const renderBuilder = () => {
    builderRoot.innerHTML = "";
    if (!builderState.rootId) {
      builderEmpty.classList.remove("hidden");
      if (builderCount) {
        builderCount.textContent = "0 item";
      }
      return;
    }
    builderEmpty.classList.add("hidden");
    const rootNode = findNode(builderState.rootId);
    if (rootNode) {
      builderRoot.appendChild(renderNode(rootNode));
    }
    if (builderCount) {
      const totalItems = builderState.nodes.filter((node) => node.type === "item").length;
      const totalContainers = builderState.nodes.filter((node) => node.type === "container").length;
      const parts = [];
      parts.push(`${totalItems} item${totalItems > 1 ? "s" : ""}`);
      parts.push(`${totalContainers} contenant${totalContainers > 1 ? "s" : ""}`);
      builderCount.textContent = parts.join(" · ");
    }
  };

  const renderNodeTypeOptions = (select, allowedTypes, current) => {
    select.innerHTML = "";
    allowedTypes.forEach((type) => {
      const option = document.createElement("option");
      option.value = type;
      option.textContent = type === "container" ? "Contenant" : "Item";
      if (type === current) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  };

  const renderParentOptions = (node) => {
    nodeParentSelect.innerHTML = "";
    const rootOption = document.createElement("option");
    rootOption.value = "";
    rootOption.textContent = "Racine";
    nodeParentSelect.appendChild(rootOption);

    builderState.nodes
      .filter((candidate) => candidate.type === "container")
      .forEach((candidate) => {
        if (candidate.id === node.id) {
          return;
        }
        if (isDescendant(node.id, candidate.id)) {
          return;
        }
        const depth = getDepth(candidate.id);
        const option = document.createElement("option");
        option.value = candidate.id;
        option.textContent = `${candidate.name} (niveau ${depth})`;
        if (candidate.id === node.parentId) {
          option.selected = true;
        }
        nodeParentSelect.appendChild(option);
      });
  };

  const addChild = () => {
    const parent = findNode(builderState.selectedId);
    if (!parent || parent.type !== "container") {
      return;
    }
    const name = normalizeLabel(childNameInput.value);
    if (!name) {
      return;
    }
    const type = childTypeSelect.value;
    const qty = type === "item" && childQtyInput.value !== "" ? Number(childQtyInput.value) : null;
    createNode({ name, type, qty, parentId: parent.id });
    childNameInput.value = "";
    childQtyInput.value = "";
    renderBuilder();
    closeDialog(nodeModal);
  };

  saveNodeButton.addEventListener("click", () => {
    const node = findNode(builderState.selectedId);
    if (!node) {
      return;
    }
    const name = normalizeLabel(nodeNameInput.value);
    if (!name) {
      return;
    }
    node.name = name;
    node.type = nodeTypeSelect.value;
    node.qty = node.type === "item" && nodeQtyInput.value !== "" ? Number(nodeQtyInput.value) : null;
    const newParent = nodeParentSelect.value || null;
    if (node.id === builderState.rootId && newParent) {
      return;
    }
    if (newParent !== node.parentId) {
      node.parentId = newParent;
      if (!newParent) {
        builderState.rootId = node.id;
      }
    }
    renderBuilder();
    closeDialog(nodeModal);
  });

  duplicateNodeButton.addEventListener("click", () => {
    const node = findNode(builderState.selectedId);
    if (!node || node.id === builderState.rootId) {
      return;
    }
    const cloneSubtree = (source, parentId) => {
      const newNode = createNode({
        name: `${source.name} (copie)`,
        type: source.type,
        qty: source.qty,
        parentId,
      });
      getChildren(source.id).forEach((child) => cloneSubtree(child, newNode.id));
      return newNode.id;
    };
    cloneSubtree(node, node.parentId);
    renderBuilder();
    closeDialog(nodeModal);
  });

  deleteNodeButton.addEventListener("click", () => {
    const node = findNode(builderState.selectedId);
    if (!node || node.id === builderState.rootId) {
      return;
    }
    if (confirm("Supprimer cet élément ?")) {
      deleteNodeById(node.id);
      closeDialog(nodeModal);
    }
  });

  addChildButton.addEventListener("click", addChild);
  childTypeSelect.addEventListener("change", () => {
    childQtyInput.disabled = childTypeSelect.value !== "item";
  });
  nodeTypeSelect.addEventListener("change", () => {
    nodeQtyInput.disabled = nodeTypeSelect.value !== "item";
    const node = findNode(builderState.selectedId);
    if (node) {
      renderParentOptions(node);
    }
  });

  const loadParentById = (selectedId) => {
    const material = materialMap.get(selectedId);
    if (!material) {
      return;
    }
    resetBuilder();
    builderState.rootId = cloneTree(material, null);
    builderState.rootMaterialId = selectedId;
    builderState.selectedId = builderState.rootId;
    renderBuilder();
  };

  sacsGrid?.addEventListener("click", (event) => {
    const button = event.target.closest(".sac-open");
    if (!button) {
      return;
    }
    const draftId = button.dataset.draftId;
    if (draftId) {
      builderState.selectedId = builderState.rootId;
      renderBuilder();
      builderRoot.scrollIntoView({ behavior: "smooth", block: "start" });
      return;
    }
    const selectedId = Number(button.dataset.parentId);
    if (!selectedId) {
      return;
    }
    loadParentById(selectedId);
    builderRoot.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  const toggleRootQty = () => {
    const isItem = rootTypeSelect.value === "item";
    rootQtyWrapper.classList.toggle("hidden", !isItem);
    rootQtyInput.disabled = !isItem;
  };

  rootTypeSelect.addEventListener("change", toggleRootQty);

  openRootModalButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const modal = document.getElementById("root-modal");
      toggleRootQty();
      openDialog(modal);
    });
  });

  jumpToBuilderButton?.addEventListener("click", () => {
    builderRoot.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  document.getElementById("create-root").addEventListener("click", () => {
    const input = document.getElementById("root-name");
    const name = normalizeLabel(input.value);
    if (!name) {
      return;
    }
    const rootType = rootTypeSelect.value;
    const rootQty = rootType === "item" && rootQtyInput.value !== "" ? Number(rootQtyInput.value) : null;
    resetBuilder();
    setRoot(name, rootType, rootQty);
    builderState.rootMaterialId = null;
    addDraftSac(name, builderState.rootId);
    input.value = "";
    rootQtyInput.value = "";
    closeDialog(document.getElementById("root-modal"));
  });

  nodeModalCancel.addEventListener("click", () => {
    closeDialog(nodeModal);
  });

  rootModalCancel?.addEventListener("click", () => {
    closeDialog(document.getElementById("root-modal"));
  });

  document.querySelectorAll('[data-action="open-duplicate-modal"]').forEach((button) => {
    button.addEventListener("click", () => {
      const sourceId = button.dataset.parentId;
      const parentName = button.dataset.parentName || "";
      if (!sourceId) {
        return;
      }
      duplicateSourceIdInput.value = sourceId;
      duplicateNameInput.value = parentName ? `${parentName} (copie)` : "";
      openDialog(duplicateModal);
      duplicateNameInput.focus();
      duplicateNameInput.select();
    });
  });

  duplicateModalCancel?.addEventListener("click", () => {
    closeDialog(duplicateModal);
  });

  const closeAllLotForms = () => {
    document.querySelectorAll(".lot-edit-form").forEach((form) => {
      form.setAttribute("hidden", "");
      const lotId = form.dataset.lotId;
      const toggleButton = document.querySelector(
        `[data-action="toggle-lot-form"][data-lot-id="${lotId}"]`
      );
      if (toggleButton) {
        toggleButton.textContent = "Modifier";
      }
    });
  };

  lotToggleButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const lotId = button.dataset.lotId;
      const form = document.getElementById(`lot-form-${lotId}`);
      if (!form) {
        return;
      }
      const isHidden = form.hasAttribute("hidden");
      closeAllLotForms();
      if (isHidden) {
        form.removeAttribute("hidden");
        button.textContent = "Fermer";
      }
    });
  });

  lotCloseButtons.forEach((button) => {
    button.addEventListener("click", () => {
      closeAllLotForms();
    });
  });

  importParentsButtons.forEach((button) => {
    button.addEventListener("click", () => {
      parentsImportFile?.click();
    });
  });

  parentsImportFile?.addEventListener("change", () => {
    const file = parentsImportFile.files?.[0];
    if (!file) {
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      const text = reader.result;
      if (typeof text !== "string") {
        return;
      }
      parentsImportPayload.value = text;
      parentsImportForm?.submit();
    };
    reader.readAsText(file);
  });

  builderForm.addEventListener("submit", (event) => {
    if (!builderState.rootId) {
      event.preventDefault();
      return;
    }
    const root = findNode(builderState.rootId);
    const rootChildren = getChildren(root.id);
    if (!rootChildren.length && root.type === "container") {
      event.preventDefault();
      return;
    }
    const serializeNode = (node) => ({
      name: node.name,
      type: node.type,
      qty: node.qty,
      children: getChildren(node.id).map((child) => serializeNode(child)),
    });
    const payload = {
      root: serializeNode(root),
    };
    if (builderState.rootMaterialId) {
      payload.root_id = builderState.rootMaterialId;
    }
    builderPayload.value = JSON.stringify(payload);
  });

  renderBuilder();
</script>
{% endblock %}
