{% extends "base.html" %}
{% block content %}
<section class="card">
  <div class="page-header">
    <div>
      <h1 class="page-title">Postes de secours</h1>
      <p class="page-subtitle">Suivez l'Ã©tat des postes actifs et leur progression de checklist.</p>
    </div>
    <div class="page-actions">
      <div class="search-input">
        ğŸ”
        <input type="text" id="event-search" placeholder="Rechercher un poste" />
      </div>
      <a class="btn" href="/events/new">Nouveau poste</a>
    </div>
  </div>
  <div class="filter-chips" id="event-filters">
    <button class="filter-chip active" type="button" data-status="all">Tous</button>
    <button class="filter-chip" type="button" data-status="open">Ouverts</button>
    <button class="filter-chip" type="button" data-status="in_progress">En cours</button>
    <button class="filter-chip" type="button" data-status="completed">TerminÃ©s</button>
    <button class="filter-chip" type="button" data-status="closed">FermÃ©s</button>
  </div>

  <div class="list-card" id="events-list">
    {% for item in event_cards %}
    <article
      class="list-card-item"
      data-name="{{ item.event.name | lower }}"
      data-status="{{ item.state }}"
    >
      <div>
        <h3>{{ item.event.name }}</h3>
        <div class="list-card-meta">
          <span class="pill {{ item.state_class }}">{{ item.state_label }}</span>
          {% if item.event.date %}
          <span>ğŸ“… {{ item.date_label }}</span>
          {% endif %}
          <span>ğŸ§° {{ item.progress.total }} Ã©lÃ©ments</span>
          {% if item.last_update_label %}
          <span>â±ï¸ {{ item.last_update_label }}</span>
          {% endif %}
        </div>
        <div class="progress">
          <div class="progress-bar" style="width: {{ item.progress.percent }}%"></div>
        </div>
        <div class="stats modern">
          <span class="stat-pill ok">OK: {{ item.progress.ok }}</span>
          <span class="stat-pill problem">ProblÃ¨mes: {{ item.progress.problem }}</span>
          <span class="stat-pill pending">En attente: {{ item.progress.pending }}</span>
        </div>
        <p class="muted">{{ item.event.info or 'Aucune information complÃ©mentaire.' }}</p>
      </div>
      <div class="list-card-actions">
        <a class="btn" href="/events/{{ item.event.id }}">DÃ©tails</a>
        <form method="post" action="/events/{{ item.event.id }}/delete">
          <button class="btn danger" type="submit" onclick="return confirm('Supprimer ce poste ?');">
            Supprimer
          </button>
        </form>
      </div>
    </article>
    {% else %}
    <div class="empty-state">Aucun poste crÃ©Ã©. Lancez un nouveau poste pour dÃ©marrer.</div>
    {% endfor %}
  </div>
</section>

<script>
  const eventSearch = document.getElementById('event-search');
  const eventFilters = document.getElementById('event-filters');
  const eventList = document.getElementById('events-list');
  let currentFilter = 'all';

  const filterEvents = () => {
    const query = eventSearch.value.trim().toLowerCase();
    eventList.querySelectorAll('.list-card-item').forEach((card) => {
      const matchesSearch = card.dataset.name.includes(query);
      const matchesFilter = currentFilter === 'all' || card.dataset.status === currentFilter;
      card.style.display = matchesSearch && matchesFilter ? 'grid' : 'none';
    });
  };

  eventFilters.addEventListener('click', (event) => {
    const button = event.target.closest('.filter-chip');
    if (!button) {
      return;
    }
    currentFilter = button.dataset.status;
    eventFilters.querySelectorAll('.filter-chip').forEach((chip) => chip.classList.remove('active'));
    button.classList.add('active');
    filterEvents();
  });

  eventSearch.addEventListener('input', filterEvents);
</script>
{% endblock %}
