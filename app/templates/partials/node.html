{% set status_label = 'OK' if branch.status == 'ok' else 'Problème' if branch.status == 'problem' else 'En attente' %}
{% if branch.node.node_type == 'container' %}
  <details
    class="tree-node is-container {{ branch.status or '' }}{% if branch.node.loaded_at %} loaded{% endif %}"
    data-node-id="{{ branch.node.id }}"
    data-parent-id="{{ branch.node.parent_id if branch.node.parent_id is not none else 'root' }}"
    data-node-type="{{ branch.node.node_type }}"
    data-status="{{ branch.status or 'pending' }}"
    data-load-vehicle="{{ branch.node.load_vehicle or '' }}"
    data-loaded="{{ 'true' if branch.node.loaded_at else 'false' }}"
  >
    <summary class="tree-title">
      <div class="tree-title-main">
        <span class="tree-name">{{ branch.node.name }}</span>
        <span class="tree-subtitle">Contenant · {{ branch.counts.total }} élément{{ '' if branch.counts.total == 1 else 's' }}</span>
        <span class="tree-destination" data-role="load-destination" {% if not branch.node.load_vehicle %}hidden{% endif %}>
          {% if branch.node.load_vehicle %}
            Destination: {{ branch.node.load_vehicle }}
          {% endif %}
        </span>
      </div>
      <div class="tree-meta">
        <span class="status {{ branch.status }}" data-role="status">{{ status_label }}</span>
        <div class="count-row" aria-label="Compteurs de statut">
          <span class="count-pill neutral">Total {{ branch.counts.total }}</span>
          <span class="count-pill ok">OK {{ branch.counts.ok }}</span>
          <span class="count-pill problem">Problèmes {{ branch.counts.problem }}</span>
          <span class="count-pill pending">En attente {{ branch.counts.pending }}</span>
        </div>
        <button
          class="btn small secondary tree-load-btn"
          type="button"
          data-action="open-load-modal"
          data-node-id="{{ branch.node.id }}"
        >
          {% if branch.node.load_vehicle %}
            Modifier
          {% else %}
            Destination
          {% endif %}
        </button>
        <button
          class="btn small tree-load-btn"
          type="button"
          data-action="bulk-ok"
          data-node-id="{{ branch.node.id }}"
        >
          OK
        </button>
        <button
          class="btn small tree-load-btn"
          type="button"
          data-action="charge-load"
          data-node-id="{{ branch.node.id }}"
          {% if not branch.node.load_vehicle or branch.node.loaded_at or branch.status != 'ok' %}disabled{% endif %}
        >
          {% if branch.node.loaded_at %}
            Chargé
          {% else %}
            Charger
          {% endif %}
        </button>
      </div>
      <span class="fold-icon" aria-hidden="true">⌄</span>
    </summary>
    {% if branch.children %}
      <div class="tree-children">
        {% for child in branch.children %}
          {% set branch = child %}
          {% include "partials/node.html" %}
        {% endfor %}
      </div>
    {% else %}
      <div class="tree-empty">Aucun élément dans ce contenant.</div>
    {% endif %}
  </details>
{% else %}
  <div
    class="tree-node is-item {{ branch.status or '' }}"
    data-node-id="{{ branch.node.id }}"
    data-parent-id="{{ branch.node.parent_id if branch.node.parent_id is not none else 'root' }}"
    data-node-type="{{ branch.node.node_type }}"
    data-status="{{ branch.status or 'pending' }}"
  >
    <div class="tree-title">
      <div class="tree-title-main">
        <span class="tree-name">{{ branch.node.name }}</span>
        <span class="qty">Qté attendue: {{ branch.node.expected_qty or '-' }}</span>
      </div>
      <span class="status {{ branch.status }}" data-role="status">{{ status_label }}</span>
    </div>
    <div class="tree-note" data-role="comment">
      {% if branch.node.comment %}
        {{ branch.node.comment }}
      {% else %}
        Aucun commentaire.
      {% endif %}
    </div>
    <div class="tree-actor" data-role="verifier">
      Dernière action: {{ branch.node.last_verifier_name or 'Non renseigné' }}
    </div>
  </div>
{% endif %}
