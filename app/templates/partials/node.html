{% set status_label = 'OK' if branch.status == 'ok' else 'Problème' if branch.status == 'problem' else 'En attente' %}
{% if branch.node.node_type == 'container' %}
  <details
    class="tree-node is-container {{ branch.status or '' }}{% if branch.node.loaded_at %} loaded{% endif %}"
    data-node-id="{{ branch.node.id }}"
    data-parent-id="{{ branch.node.parent_id if branch.node.parent_id is not none else 'root' }}"
    data-node-type="{{ branch.node.node_type }}"
    data-status="{{ branch.status or 'pending' }}"
    data-load-vehicle="{{ branch.node.load_vehicle or '' }}"
    data-loaded="{{ 'true' if branch.node.loaded_at else 'false' }}"
  >
    <summary class="tree-title">
      <div class="tree-title-main">
        <span class="tree-name">{{ branch.node.name }}</span>
        <span class="tree-subtitle">Contenant · {{ branch.counts.total }} élément{{ '' if branch.counts.total == 1 else 's' }}</span>
        <span class="tree-destination" data-role="load-destination" {% if not branch.node.load_vehicle and not branch.node.loaded_at %}hidden{% endif %}>
          {% if branch.node.load_vehicle %}
            Destination: {{ branch.node.load_vehicle }}
          {% elif branch.node.loaded_at %}
            Chargé dans véhicule non renseigné
          {% endif %}
        </span>
      </div>
      <div class="tree-meta">
        <span class="status {{ branch.status }}" data-role="status">{{ status_label }}</span>
        <span class="status-card-pill loaded" data-role="load-status" {% if not branch.node.loaded_at %}hidden{% endif %}>
          ✅ Chargé
        </span>
        <div class="count-row" aria-label="Compteurs de statut">
          <span class="count-pill neutral">Total {{ branch.counts.total }}</span>
          <span class="count-pill ok">OK {{ branch.counts.ok }}</span>
          <span class="count-pill problem">Problèmes {{ branch.counts.problem }}</span>
          <span class="count-pill pending">En attente {{ branch.counts.pending }}</span>
        </div>
      </div>
      {% if show_parent_actions %}
        <div class="tree-parent-actions">
          <button
            class="btn small secondary"
            type="button"
            data-action="open-load-modal"
            data-node-id="{{ branch.node.id }}"
            data-node-name="{{ branch.node.name }}"
            data-load-mode="destination"
            onclick="const modal=document.getElementById('load-modal');if(!modal){return false;}const nodeId=this.dataset.nodeId||'';modal.dataset.activeNodeId=nodeId;const name=this.dataset.nodeName||'Sac';const subtitle=modal.querySelector('#load-modal-subtitle');if(subtitle){subtitle.textContent='Où le sac \"'+name+'\" va-t-il être chargé ?';}modal.classList.add('is-open');modal.setAttribute('open','');modal.setAttribute('aria-hidden','false');const input=modal.querySelector('#load-vehicle-name');if(input){input.focus();}return false;"
          >
            {% if branch.node.load_vehicle %}
              Modifier
            {% else %}
              Destination
            {% endif %}
          </button>
          <form
            method="post"
            action="/events/{{ event.id }}/nodes/{{ branch.node.id }}/bulk-ok"
            class="inline-form"
            data-node-id="{{ branch.node.id }}"
          >
            <button
              class="btn small"
              type="submit"
              data-action="bulk-ok"
              data-node-id="{{ branch.node.id }}"
            >
              OK
            </button>
          </form>
          <button
            class="btn small"
            type="button"
            data-action="charge-load"
            data-node-id="{{ branch.node.id }}"
            data-load-mode="charge"
            data-role="charge-button"
            {% if branch.node.loaded_at or branch.status != 'ok' %}disabled{% endif %}
          >
            {% if branch.node.loaded_at %}
              Chargé
            {% else %}
              Charger
            {% endif %}
          </button>
        </div>
      {% endif %}
      <span class="fold-icon" aria-hidden="true">⌄</span>
    </summary>
    {% if branch.children %}
      <div class="tree-children">
        {% for child in branch.children %}
          {% set branch = child %}
          {% include "partials/node.html" %}
        {% endfor %}
      </div>
    {% else %}
      <div class="tree-empty">Aucun élément dans ce contenant.</div>
    {% endif %}
  </details>
{% else %}
  <div
    class="tree-node is-item {{ branch.status or '' }}"
    data-node-id="{{ branch.node.id }}"
    data-parent-id="{{ branch.node.parent_id if branch.node.parent_id is not none else 'root' }}"
    data-node-type="{{ branch.node.node_type }}"
    data-status="{{ branch.status or 'pending' }}"
  >
    <div class="tree-title">
      <div class="tree-title-main">
        <span class="tree-name">{{ branch.node.name }}</span>
        <span class="qty">Qté attendue: {{ branch.node.expected_qty or '-' }}</span>
      </div>
      <div class="tree-item-actions">
        <span class="status {{ branch.status }}" data-role="status">{{ status_label }}</span>
        <form method="post" action="/events/{{ event.id }}/nodes/{{ branch.node.id }}/bulk-ok" class="inline-form">
          <button
            class="btn small"
            type="submit"
            data-action="bulk-ok"
            data-node-id="{{ branch.node.id }}"
          >
            OK
          </button>
        </form>
      </div>
    </div>
    <div class="tree-note" data-role="comment">
      {% if branch.node.comment %}
        {{ branch.node.comment }}
      {% else %}
        Aucun commentaire.
      {% endif %}
    </div>
    <div class="tree-actor" data-role="verifier">
      Dernière action: {{ branch.node.last_verifier_name or 'Non renseigné' }}
    </div>
  </div>
{% endif %}
