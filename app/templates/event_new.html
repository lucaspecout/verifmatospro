{% extends "base.html" %}
{% block content %}
{% if error %}
  <p class="error">{{ error }}</p>
{% endif %}
<section class="card">
  <div class="page-header">
    <div>
      <h1 class="page-title">Nouveau poste</h1>
      <p class="page-subtitle">Préparez la mission avec une checklist complète et partageable.</p>
    </div>
    <span class="pill">Configuration</span>
  </div>
  <form method="post" action="/events" class="form">
    <label>Nom du poste
      <input type="text" name="name" required />
      <span class="help-text">Exemple : Festival été - J2</span>
    </label>
    <label>Date
      <input type="date" name="date_value" />
    </label>
    <label>Informations utiles
      <textarea name="info" rows="3" placeholder="Adresse, consignes, horaires..."></textarea>
    </label>
    <label>Sélectionner des lots
      <select name="lot_ids" multiple id="lot-select">
        {% for lot in lots %}
        <option value="{{ lot.id }}">{{ lot.name }}</option>
        {% endfor %}
      </select>
      <span class="help-text">Exemple : lot rouge, lot VPS, lot bleu.</span>
    </label>
    <label>Sélectionner des sacs spécifiques
      <select name="template_ids" multiple id="template-select">
        {% for item in templates %}
        <option value="{{ item.id }}">{{ item.name }}</option>
        {% endfor %}
      </select>
      <span class="help-text">Choisissez des sacs supplémentaires si besoin.</span>
    </label>
    <div class="stat-grid">
      <div class="stat-card">
        <span class="stat-label">Sélection actuelle</span>
        <strong id="template-count">0</strong>
        <span class="pill">Sacs sélectionnés</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Aperçu</span>
        <div id="template-preview" class="info-list"></div>
      </div>
    </div>
    <button type="submit" class="btn">Créer le poste</button>
  </form>
</section>

<script>
  const templateIndex = {{ template_index | tojson }};
  const lotsData = {{ lot_payload | tojson }};
  const lotsById = new Map(lotsData.map((lot) => [String(lot.id), lot]));
  const select = document.getElementById('template-select');
  const lotSelect = document.getElementById('lot-select');
  const preview = document.getElementById('template-preview');
  const count = document.getElementById('template-count');

  const collectTemplateIds = () => {
    const selectedTemplateIds = new Set(
      Array.from(select.selectedOptions).map((option) => option.value)
    );
    Array.from(lotSelect.selectedOptions).forEach((option) => {
      const lot = lotsById.get(option.value);
      if (!lot) {
        return;
      }
      lot.template_ids.forEach((templateId) => selectedTemplateIds.add(String(templateId)));
    });
    return Array.from(selectedTemplateIds);
  };

  const updatePreview = () => {
    const templateIds = collectTemplateIds();
    count.textContent = templateIds.length;
    preview.innerHTML = '';
    if (!templateIds.length) {
      preview.innerHTML = '<span class="muted">Aucun sac sélectionné.</span>';
      return;
    }
    templateIds
      .map((id) => templateIndex[id])
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b))
      .forEach((label) => {
      const item = document.createElement('div');
      item.textContent = `• ${label}`;
      preview.appendChild(item);
    });
  };

  const toggleOption = (event, selectElement) => {
    if (event.target.tagName !== 'OPTION') {
      return;
    }
    event.preventDefault();
    event.target.selected = !event.target.selected;
    selectElement.dispatchEvent(new Event('change', { bubbles: true }));
  };

  select.addEventListener('change', updatePreview);
  lotSelect.addEventListener('change', updatePreview);
  select.addEventListener('mousedown', (event) => toggleOption(event, select));
  lotSelect.addEventListener('mousedown', (event) => toggleOption(event, lotSelect));
  updatePreview();
</script>
{% endblock %}
