{% extends "base.html" %}
{% block content %}
<section class="monitor-page">
  <header class="card monitor-hero">
    <div class="monitor-hero-main">
      <div>
        <p class="eyebrow">Chef de poste</p>
        <h1>Suivi en direct ‚Äî {{ event.name }}</h1>
        <div class="monitor-meta">
          <span class="meta-pill" data-role="last-verifier">
            Dernier v√©rificateur: {{ last_verifier_name or 'Non renseign√©' }}
          </span>
          <span class="meta-pill" data-role="verifier-list">
            V√©rificateurs actifs: {{ verifier_names | join(', ') if verifier_names else 'Aucun' }}
          </span>
          <span class="meta-pill live" id="sync-status">Synchronis√©</span>
          <span class="meta-pill">Statut: {{ event_state_label }}</span>
        </div>
      </div>
      <div class="actions monitor-actions">
        <a class="btn secondary" href="/materials">Ajouter du mat√©riel</a>
        <form method="post" action="/events/{{ event.id }}/delete">
          <button class="btn danger" type="submit" onclick="return confirm('Supprimer ce poste ?');">
            Supprimer
          </button>
        </form>
      </div>
    </div>
    <div class="monitor-summary-grid">
      <div class="summary-card">
        <div class="summary-header">
          <span>Progression globale</span>
          <span class="summary-value" id="progress-percent">{{ progress.percent }}%</span>
        </div>
        <div class="progress" id="progress-bar">
          <div class="progress-bar" style="width: {{ progress.percent }}%"></div>
        </div>
        <div class="stats modern" id="progress-stats">
          <span class="stat-pill ok">OK: {{ progress.ok }}</span>
          <span class="stat-pill problem">Probl√®mes: {{ progress.problem }}</span>
          <span class="stat-pill pending">En attente: {{ progress.pending }}</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-header">
          <span>Synchronisation</span>
          <span class="summary-value">Temps r√©el</span>
        </div>
        <div class="sync-status">
          <span class="sync-dot"></span>
          <div>
            <strong>Flux actif</strong>
            <p class="muted" id="last-update">En attente de mise √† jour.</p>
          </div>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-header">
          <span>Pr√™t au d√©part</span>
          <span class="summary-value">Checklist</span>
        </div>
        <ul class="summary-steps">
          <li>Valider chaque √©quipement.</li>
          <li>Signaler les manquants ou pannes.</li>
          <li>Synchronisation instantan√©e avec le poste.</li>
          <li>Statut final enregistr√© automatiquement.</li>
        </ul>
      </div>
    </div>
  </header>

  <div class="monitor-grid">
    <section class="card monitor-checklist">
      <div class="section-header">
        <div>
          <h2>Checklist mat√©riel</h2>
          <p class="muted">Mise √† jour imm√©diate d√®s qu'un v√©rificateur agit.</p>
        </div>
        <span class="section-chip">Live</span>
      </div>
      {% if parent_tiles %}
        <div class="status-grid status-grid--parents monitor-tiles" aria-label="Statut rapide du mat√©riel">
          {% for parent in parent_tiles %}
            {% set parent_status = parent.status or 'pending' %}
            <div
              class="status-card {{ parent_status }}{% if parent.node.loaded_at %} loaded{% endif %}"
              data-node-id="{{ parent.node.id }}"
              data-status="{{ parent_status }}"
              data-load-vehicle="{{ parent.node.load_vehicle or '' }}"
              data-loaded="{{ 'true' if parent.node.loaded_at else 'false' }}"
            >
              <div class="status-card-name">{{ parent.node.name }}</div>
              <div class="status-card-meta">
                <span class="status-card-pill {{ parent_status }}">
                  {% if parent_status == 'ok' %}
                    OK
                  {% elif parent_status == 'problem' %}
                    Probl√®me
                  {% else %}
                    En attente
                  {% endif %}
                </span>
                <span class="status-card-pill loaded" data-role="load-status" {% if not parent.node.loaded_at %}hidden{% endif %}>
                  ‚úÖ Charg√©
                </span>
                <span class="status-card-location" data-role="load-info" {% if not parent.node.load_vehicle and not parent.node.loaded_at %}hidden{% endif %}>
                  {% if parent.node.load_vehicle %}
                    Destination: {{ parent.node.load_vehicle }}
                  {% elif parent.node.loaded_at %}
                    Charg√© dans v√©hicule non renseign√©
                  {% endif %}
                </span>
                <button
                  class="btn small secondary status-card-load"
                  type="button"
                  data-action="open-load-modal"
                  data-node-id="{{ parent.node.id }}"
                  data-node-name="{{ parent.node.name }}"
                  data-load-mode="destination"
                  onclick="const modal=document.getElementById('load-modal');if(!modal){return false;}const nodeId=this.dataset.nodeId||'';modal.dataset.activeNodeId=nodeId;const name=this.dataset.nodeName||'Sac';const subtitle=modal.querySelector('#load-modal-subtitle');if(subtitle){subtitle.textContent='O√π le sac \"'+name+'\" va-t-il √™tre charg√© ?';}modal.classList.add('is-open');modal.setAttribute('open','');modal.setAttribute('aria-hidden','false');const input=modal.querySelector('#load-vehicle-name');if(input){input.focus();}return false;"
                >
                  {% if parent.node.load_vehicle %}
                    Modifier
                  {% else %}
                    Destination
                  {% endif %}
                </button>
                <form
                  method="post"
                  action="/events/{{ event.id }}/nodes/{{ parent.node.id }}/bulk-ok"
                  class="inline-form"
                  data-node-id="{{ parent.node.id }}"
                >
                  <button
                    class="btn small status-card-load"
                    type="submit"
                    data-action="bulk-ok"
                    data-node-id="{{ parent.node.id }}"
                  >
                    OK
                  </button>
                </form>
                <button
                  class="btn small status-card-load"
                  type="button"
                  data-action="charge-load"
                  data-node-id="{{ parent.node.id }}"
                  data-load-mode="charge"
                  data-role="charge-button"
                  {% if parent.node.loaded_at or parent_status != 'ok' %}disabled{% endif %}
                >
                  {% if parent.node.loaded_at %}
                    Charg√©
                  {% else %}
                    Charger
                  {% endif %}
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
      {% set show_parent_actions = true %}
      <div class="tree" id="monitor-tree">
        {% for branch in tree %}
          {% include "partials/node.html" with context %}
        {% endfor %}
      </div>
    </section>

    <aside class="monitor-aside">
      <div class="card quick-panel">
        <div class="panel-title">Lien public</div>
        <p class="muted">Partagez le lien avec le v√©rificateur terrain.</p>
        <div class="public-link" data-token="{{ event.public_token }}">
          {{ request.base_url }}public/{{ event.id }}/{{ event.public_token }}
        </div>
        <div class="public-link-actions">
          <button class="btn secondary" type="button" data-action="toggle-link">Afficher</button>
          <button class="btn" type="button" data-action="copy-link">Copier</button>
        </div>
      </div>
      <div class="card quick-panel">
        <div class="panel-title">Contr√¥le final</div>
        <div class="final-checklist">
          <div class="final-step">
            <span>‚ö°</span>
            <div>
              <strong>Synchronisation active</strong>
              <p class="muted">Les retours apparaissent en temps r√©el.</p>
            </div>
          </div>
          <div class="final-step">
            <span>üß≠</span>
            <div>
              <strong>Validation d√©part</strong>
              <p class="muted">Assurez-vous que chaque section est au vert.</p>
            </div>
          </div>
          <div class="final-step">
            <span>üìù</span>
            <div>
              <strong>Commentaires</strong>
              <p class="muted">Conservez les notes pour le stock.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="card quick-panel">
        <div class="panel-title">Journal des actions</div>
        <p class="muted">Derni√®res modifications capt√©es en direct.</p>
        <div class="timeline" id="monitor-log">
          <div class="timeline-item">En attente de mise √† jour.</div>
        </div>
      </div>
    </aside>
  </div>
</section>

<div class="modal" id="load-modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="load-modal-title">
    <h2 id="load-modal-title" class="modal-title">Destination</h2>
    <p class="muted" id="load-modal-subtitle"></p>
    <form class="modal-form">
      <label>Nom du v√©hicule
        <input
          type="text"
          id="load-vehicle-name"
          name="vehicle_name"
          placeholder="Ex: V√©hicule 1"
          required
        />
      </label>
      <div class="modal-actions">
        <button class="btn secondary" type="button" data-action="cancel-load">Annuler</button>
        <button class="btn" type="submit">Confirmer</button>
      </div>
    </form>
  </div>
</div>

<script>
  const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${protocol}://${location.host}/ws/events/{{ event.id }}`);

  const statusLabels = {
    ok: 'OK',
    problem: 'Probl√®me',
    pending: 'En attente',
  };
  const verifierSeed = {{ verifier_names | tojson }};
  const verifierSet = new Set(Array.isArray(verifierSeed) ? verifierSeed : []);

  const resolveNodeContainer = (element) => {
    if (!element || !element.closest) {
      return null;
    }
    const raw = element.closest('[data-node-id]');
    if (!raw) {
      return null;
    }
    if (raw.matches('button')) {
      return raw.closest('[data-node-id]:not(button)') || raw;
    }
    return raw;
  };

  const updateProgress = (progress) => {
    const bar = document.querySelector('#progress-bar .progress-bar');
    if (bar) {
      bar.style.width = `${progress.percent}%`;
    }
    const percent = document.querySelector('#progress-percent');
    if (percent) {
      percent.textContent = `${progress.percent}%`;
    }
    const stats = document.querySelector('#progress-stats');
    if (stats) {
      stats.innerHTML = `
        <span class="stat-pill ok">OK: ${progress.ok}</span>
        <span class="stat-pill problem">Probl√®mes: ${progress.problem}</span>
        <span class="stat-pill pending">En attente: ${progress.pending}</span>
      `;
    }
  };

  const loadModal = document.querySelector('#load-modal');
  const loadForm = loadModal?.querySelector('.modal-form');
  const loadCancelButton = loadModal?.querySelector('[data-action="cancel-load"]');
  const loadVehicleInput = loadModal?.querySelector('#load-vehicle-name');
  const loadModalSubtitle = loadModal?.querySelector('#load-modal-subtitle');
  const loadModalTitle = loadModal?.querySelector('#load-modal-title');
  const loadSubmitButton = loadModal?.querySelector('button[type="submit"]');
  const loadState = new Map();
  let activeLoadNodeId = null;

  document
    .querySelectorAll('.status-card[data-load-vehicle], .tree-node.is-container[data-load-vehicle]')
    .forEach((node) => {
      const vehicle = node.dataset.loadVehicle?.trim();
      const loaded = node.dataset.loaded === 'true';
      if (vehicle || loaded) {
        loadState.set(node.dataset.nodeId, { vehicle, loaded });
      }
    });

  const closeLoadModal = () => {
    if (!loadModal) {
      return;
    }
    loadModal.classList.remove('is-open');
    loadModal.removeAttribute('open');
    loadModal.setAttribute('aria-hidden', 'true');
    activeLoadNodeId = null;
  };

  const openLoadModal = (nodeId, nodeName) => {
    if (!loadModal || !nodeId || !loadVehicleInput || !loadModalSubtitle) {
      return;
    }
    activeLoadNodeId = nodeId;
    loadModal.dataset.activeNodeId = nodeId;
    const currentInfo = loadState.get(nodeId);
    const resolvedName = nodeName?.trim() || 'Sac';
    loadModalSubtitle.textContent = `O√π le sac "${resolvedName}" va-t-il √™tre charg√© ?`;
    loadVehicleInput.value = currentInfo?.vehicle || '';
    loadModal.classList.add('is-open');
    loadModal.setAttribute('open', '');
    loadModal.setAttribute('aria-hidden', 'false');
    loadVehicleInput.focus();
  };

  window.openLoadModal = openLoadModal;

  const handleLoadModalClick = (button) => {
    if (!button) {
      return;
    }
    const container = resolveNodeContainer(button);
    if (!container || button.hidden) {
      return;
    }
    const nodeId = container.dataset.nodeId;
    if (!nodeId) {
      return;
    }
    const nodeName =
      button.dataset.nodeName?.trim() ||
      container?.querySelector('.status-card-name')?.textContent?.trim() ||
      container?.querySelector('.tree-name')?.textContent?.trim() ||
      'Sac';
    openLoadModal(nodeId, nodeName);
  };

  window.handleLoadModalClick = handleLoadModalClick;

  const applyLoadState = (tile) => {
    if (!tile) {
      return;
    }
    const nodeId = tile.dataset.nodeId;
    const loadInfo = loadState.get(nodeId);
    const isLoaded = Boolean(loadInfo?.loaded);
    const isReady = tile.dataset.status === 'ok';
    const loadInfoEl = tile.querySelector('[data-role="load-info"]');
    const loadButton = tile.querySelector('[data-action="open-load-modal"]');
    const chargeButton = tile.querySelector('[data-role="charge-button"]');
    const statusPill = tile.querySelector('.status-card-pill');
    const loadStatus = tile.querySelector('[data-role="load-status"]');
    if (loadInfoEl) {
      if (loadInfo?.vehicle) {
        loadInfoEl.textContent = `Destination: ${loadInfo.vehicle}`;
        loadInfoEl.hidden = false;
      } else if (isLoaded) {
        loadInfoEl.textContent = 'Charg√© dans v√©hicule non renseign√©';
        loadInfoEl.hidden = false;
      } else {
        loadInfoEl.hidden = true;
      }
    }
    tile.classList.toggle('loaded', isLoaded);
    if (statusPill) {
      statusPill.classList.toggle('loaded', isLoaded);
    }
    if (loadStatus) {
      loadStatus.hidden = !isLoaded;
    }
    if (loadButton) {
      loadButton.textContent = loadInfo?.vehicle ? 'Modifier' : 'Destination';
    }
    if (chargeButton) {
      chargeButton.textContent = isLoaded ? 'Charg√©' : 'Charger';
      const disableCharge = isLoaded || !isReady;
      chargeButton.toggleAttribute('disabled', disableCharge);
      chargeButton.setAttribute('aria-disabled', disableCharge ? 'true' : 'false');
    }
  };

  const updateLoadDestination = (nodeId, vehicle, loaded = false) => {
    const value = vehicle?.trim();
    if (value || loaded) {
      loadState.set(nodeId, { vehicle: value, loaded });
    } else {
      loadState.delete(nodeId);
    }
    const tile = document.querySelector(`.status-card[data-node-id="${nodeId}"]`);
    if (tile) {
      tile.dataset.loadVehicle = value || '';
      tile.dataset.loaded = loaded ? 'true' : 'false';
      applyLoadState(tile);
    }
    const treeNode = document.querySelector(`.tree-node.is-container[data-node-id="${nodeId}"]`);
    if (treeNode) {
      treeNode.dataset.loadVehicle = value || '';
      treeNode.dataset.loaded = loaded ? 'true' : 'false';
      treeNode.classList.toggle('loaded', loaded);
      const destination = treeNode.querySelector('[data-role="load-destination"]');
      const loadButton = treeNode.querySelector('[data-action="open-load-modal"]');
      const chargeButton = treeNode.querySelector('[data-action="charge-load"]');
      const loadStatus = treeNode.querySelector('[data-role="load-status"]');
      if (destination) {
        if (value) {
          destination.textContent = `Destination: ${value}`;
          destination.hidden = false;
        } else if (loaded) {
          destination.textContent = 'Charg√© dans v√©hicule non renseign√©';
          destination.hidden = false;
        } else {
          destination.hidden = true;
        }
      }
      if (loadStatus) {
        loadStatus.hidden = !loaded;
      }
      if (loadButton) {
        loadButton.textContent = value ? 'Modifier' : 'Destination';
      }
      if (chargeButton) {
        chargeButton.textContent = loaded ? 'Charg√©' : 'Charger';
        const disableCharge = loaded || treeNode.dataset.status !== 'ok';
        chargeButton.toggleAttribute('disabled', disableCharge);
        chargeButton.setAttribute('aria-disabled', disableCharge ? 'true' : 'false');
      }
    }
  };

  const setNodeStatus = (node, status, comment, verifierName) => {
    node.dataset.status = status || 'pending';
    node.classList.remove('ok', 'problem', 'pending');
    if (status) {
      node.classList.add(status);
    }
    const badge = node.querySelector('[data-role="status"]');
    if (badge) {
      badge.textContent = statusLabels[status] || status;
      badge.classList.remove('ok', 'problem', 'pending');
      if (status) {
        badge.classList.add(status);
      }
    }
    const commentEl = node.querySelector('[data-role="comment"]');
    if (commentEl && typeof comment !== 'undefined') {
      commentEl.textContent = comment || 'Aucun commentaire.';
    }
    const verifierEl = node.querySelector('[data-role="verifier"]');
    if (verifierEl && typeof verifierName !== 'undefined') {
      verifierEl.textContent = verifierName ? `Derni√®re action: ${verifierName}` : 'Derni√®re action: Non renseign√©';
    }
    if (node.dataset.nodeType === 'container') {
      const chargeButton = node.querySelector('[data-action="charge-load"]');
      if (chargeButton) {
        const vehicle = node.dataset.loadVehicle?.trim();
        const loaded = node.dataset.loaded === 'true';
        const disableCharge = loaded || status !== 'ok';
        chargeButton.toggleAttribute('disabled', disableCharge);
        chargeButton.setAttribute('aria-disabled', disableCharge ? 'true' : 'false');
      }
    }
    if (node.dataset.nodeType === 'container' && status === 'ok') {
      node.removeAttribute('open');
    }
  };

  const refreshParentTiles = () => {
    document.querySelectorAll('.status-card[data-node-id]').forEach((tile) => {
      const nodeId = tile.dataset.nodeId;
      const node = document.querySelector(`.tree-node[data-node-id="${nodeId}"]`);
      if (!node) {
        return;
      }
      const status = node.dataset.status || 'pending';
      tile.classList.remove('ok', 'problem', 'pending');
      tile.classList.add(status);
      tile.dataset.status = status;
      const pill = tile.querySelector('.status-card-pill');
      if (pill) {
        pill.classList.remove('ok', 'problem', 'pending');
        pill.classList.add(status);
        if (status === 'ok') {
          pill.textContent = 'OK';
        } else if (status === 'problem') {
          pill.textContent = 'Probl√®me';
        } else {
          pill.textContent = 'En attente';
        }
      }
      applyLoadState(tile);
    });
  };

  const updateContainerCounts = (containerNode) => {
    if (!containerNode) {
      return;
    }
    const items = containerNode.querySelectorAll('.tree-node.is-item');
    const totals = { total: items.length, ok: 0, problem: 0, pending: 0 };
    items.forEach((item) => {
      const status = item.dataset.status || 'pending';
      if (status === 'ok') {
        totals.ok += 1;
      } else if (status === 'problem') {
        totals.problem += 1;
      } else {
        totals.pending += 1;
      }
    });
    const totalPill = containerNode.querySelector('.count-pill.neutral');
    const okPill = containerNode.querySelector('.count-pill.ok');
    const problemPill = containerNode.querySelector('.count-pill.problem');
    const pendingPill = containerNode.querySelector('.count-pill.pending');
    if (totalPill) {
      totalPill.textContent = `Total ${totals.total}`;
    }
    if (okPill) {
      okPill.textContent = `OK ${totals.ok}`;
    }
    if (problemPill) {
      problemPill.textContent = `Probl√®mes ${totals.problem}`;
    }
    if (pendingPill) {
      pendingPill.textContent = `En attente ${totals.pending}`;
    }
  };

  const recomputeContainerStatus = (containerId) => {
    if (!containerId || containerId === 'root') {
      return;
    }
    const container = document.querySelector(`[data-node-id="${containerId}"]`);
    if (!container) {
      return;
    }
    const children = document.querySelectorAll(`[data-parent-id="${containerId}"]`);
    const statuses = Array.from(children).map((child) => child.dataset.status || 'pending');
    let nextStatus = 'pending';
    if (statuses.every((status) => status === 'ok')) {
      nextStatus = 'ok';
    } else if (statuses.some((status) => status === 'problem')) {
      nextStatus = 'problem';
    }
    setNodeStatus(container, nextStatus);
    updateContainerCounts(container);
    recomputeContainerStatus(container.dataset.parentId);
  };

  const applyBulkOkToContainer = (containerNode, verifierName = '') => {
    if (!containerNode) {
      return;
    }
    containerNode.querySelectorAll('.tree-node.is-item').forEach((node) => {
      setNodeStatus(node, 'ok', '', verifierName);
    });
    recomputeContainerStatus(containerNode.dataset.nodeId);
    refreshParentTiles();
  };

  const applyOkFallback = (targetNode, verifierName = '') => {
    if (!targetNode) {
      return;
    }
    if (targetNode.dataset.nodeType === 'item') {
      setNodeStatus(targetNode, 'ok', '', verifierName);
      recomputeContainerStatus(targetNode.dataset.parentId);
      refreshParentTiles();
      return;
    }
    applyBulkOkToContainer(targetNode, verifierName);
  };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'progress') {
      updateProgress(data.progress);
      const node = document.querySelector(`.tree-node[data-node-id="${data.node_id}"]`);
      if (node) {
        setNodeStatus(node, data.status, data.comment, data.verifier_name);
        recomputeContainerStatus(node.dataset.parentId);
        const nodeName = node.querySelector('.tree-name')?.textContent || '√âquipement';
        const lastUpdate = document.querySelector('#last-update');
        const log = document.querySelector('#monitor-log');
        if (lastUpdate) {
          const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
          const verifierLabel = data.verifier_name ? `par ${data.verifier_name}` : 'par un v√©rificateur';
          lastUpdate.textContent = `${nodeName} ‚Üí ${statusLabels[data.status] || data.status} ${verifierLabel} (${time})`;
          if (log) {
            const entry = document.createElement('div');
            entry.className = 'timeline-item';
            entry.innerHTML = `
              <strong>${nodeName}</strong>
              <span class="muted">${statusLabels[data.status] || data.status} ¬∑ ${verifierLabel} ¬∑ ${time}</span>
              <span class="muted">${data.comment || 'Aucun commentaire'}</span>
            `;
            log.prepend(entry);
            const entries = log.querySelectorAll('.timeline-item');
            if (entries.length > 6) {
              entries[entries.length - 1].remove();
            }
          }
        }
        if (data.verifier_name) {
          verifierSet.add(data.verifier_name);
          const lastVerifierPill = document.querySelector('[data-role="last-verifier"]');
          if (lastVerifierPill) {
            lastVerifierPill.textContent = `Dernier v√©rificateur: ${data.verifier_name}`;
          }
          const verifierListPill = document.querySelector('[data-role="verifier-list"]');
          if (verifierListPill) {
            verifierListPill.textContent = `V√©rificateurs actifs: ${Array.from(verifierSet).join(', ')}`;
          }
        }
        refreshParentTiles();
      }
    }
    if (data.type === 'load') {
      updateLoadDestination(String(data.node_id), data.vehicle || '', Boolean(data.loaded));
    }
  };

  document.querySelectorAll('.tree-node.is-container[data-status="ok"]').forEach((node) => {
    node.removeAttribute('open');
  });

  const linkPanel = document.querySelector('.public-link');
  const toggleButton = document.querySelector('[data-action="toggle-link"]');
  const copyButton = document.querySelector('[data-action="copy-link"]');
  const linkValue = linkPanel?.textContent.trim() || '';

  if (linkPanel && toggleButton) {
    toggleButton.addEventListener('click', () => {
      linkPanel.classList.toggle('visible');
      toggleButton.textContent = linkPanel.classList.contains('visible') ? 'Masquer' : 'Afficher';
    });
  }

  if (copyButton && linkValue) {
    copyButton.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(linkValue);
        copyButton.textContent = 'Copi√©';
        setTimeout(() => {
          copyButton.textContent = 'Copier';
        }, 2000);
      } catch (err) {
        copyButton.textContent = 'Erreur';
        setTimeout(() => {
          copyButton.textContent = 'Copier';
        }, 2000);
      }
    });
  }

  document.addEventListener('click', (event) => {
    const button = event.target.closest('[data-action="open-load-modal"]');
    if (!button || event.defaultPrevented) {
      return;
    }
    event.preventDefault();
    event.stopPropagation();
    handleLoadModalClick(button);
  });

  document.querySelectorAll('[data-action="charge-load"]').forEach((button) => {
    button.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      const container = resolveNodeContainer(button);
      if (!container || button.hidden) {
        return;
      }
      const previousLabel = button.textContent;
      button.textContent = 'Chargement...';
      button.disabled = true;
      const vehicle = container.dataset.loadVehicle?.trim() || '';
      fetch(`/events/{{ event.id }}/nodes/${container.dataset.nodeId}/charge`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
        },
      })
        .then(async (response) => {
          button.textContent = previousLabel;
          button.disabled = false;
          if (!response.ok) {
            let message = 'Impossible de charger ce sac pour le moment.';
            try {
              const errorPayload = await response.json();
              if (errorPayload?.detail) {
                message = errorPayload.detail;
              }
            } catch (err) {
              // Ignore parse errors
            }
            alert(message);
            return;
          }
          const data = await response.json();
          updateLoadDestination(String(data.node_id), data.vehicle || vehicle, Boolean(data.loaded));
        })
        .catch(() => {
          button.textContent = previousLabel;
          button.disabled = false;
          alert('Erreur r√©seau pendant le chargement.');
        });
    });
  });

  const triggerBulkOk = (container) => {
    if (!container) {
      return;
    }
    const containerNode = document.querySelector(
      `.tree-node[data-node-id="${container.dataset.nodeId}"]`,
    );
    const targetNode = containerNode || container;
    fetch(`/events/{{ event.id }}/nodes/${container.dataset.nodeId}/bulk-ok`, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
      },
    })
      .then(async (response) => {
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        if (data.progress) {
          updateProgress(data.progress);
        }
        if (Array.isArray(data.updated_nodes) && data.updated_nodes.length > 0) {
          data.updated_nodes.forEach((nodeUpdate) => {
            const node = document.querySelector(`.tree-node[data-node-id="${nodeUpdate.id}"]`);
            if (node) {
              setNodeStatus(node, nodeUpdate.status, '', nodeUpdate.verifier_name || '');
              recomputeContainerStatus(node.dataset.parentId);
            }
          });
          refreshParentTiles();
        } else if (targetNode) {
          applyOkFallback(targetNode, data.verifier_name || '');
        }
      })
      .catch(() => {
        applyOkFallback(targetNode, '');
      });
  };

  document.querySelectorAll('form.inline-form[action*="/bulk-ok"]').forEach((form) => {
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      event.stopPropagation();
      const container =
        resolveNodeContainer(form) ||
        resolveNodeContainer(form.querySelector('[data-action="bulk-ok"]'));
      triggerBulkOk(container);
    });
  };

  document.querySelectorAll('[data-action="bulk-ok"]').forEach((button) => {
    button.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      const container = resolveNodeContainer(button);
      if (!container) {
        return;
      }
      event.preventDefault();
      triggerBulkOk(container);
    });
  });

  loadCancelButton?.addEventListener('click', closeLoadModal);

  loadModal?.addEventListener('click', (event) => {
    if (event.target === loadModal) {
      closeLoadModal();
    }
  });

  loadForm?.addEventListener('submit', (event) => {
    event.preventDefault();
    const resolvedNodeId = activeLoadNodeId || loadModal?.dataset.activeNodeId;
    if (!resolvedNodeId || !loadVehicleInput) {
      return;
    }
    const vehicle = loadVehicleInput.value.trim();
    if (!vehicle) {
      loadVehicleInput.focus();
      return;
    }
    const payload = new FormData();
    payload.append('vehicle_name', vehicle);
    fetch(`/events/{{ event.id }}/nodes/${resolvedNodeId}/load`, {
      method: 'POST',
      body: payload,
      headers: {
        'Accept': 'application/json',
      },
    })
      .then(async (response) => {
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        updateLoadDestination(String(data.node_id), data.vehicle || vehicle, Boolean(data.loaded));
        closeLoadModal();
      })
      .catch(() => {});
  });

  refreshParentTiles();
</script>
{% endblock %}
