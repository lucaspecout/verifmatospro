{% extends "base.html" %}
{% block content %}
<section class="event-page">
  <header class="card event-hero">
    <div class="event-hero-top">
      <div>
        <p class="eyebrow">Chef de poste</p>
        <h1>Matériel — {{ event.name }}</h1>
        <p class="muted">Ajoutez ou retirez des sacs et équipements pour la vérification.</p>
      </div>
      <div class="actions event-actions">
        <a class="btn secondary" href="/events/{{ event.id }}">Retour au poste</a>
      </div>
    </div>
  </header>

  <section class="card">
    <div class="section-header">
      <div>
        <h2>Ajouter un parent</h2>
        <p class="muted">Ajoutez un sac ou un équipement racine pour le poste.</p>
      </div>
    </div>
    {% if error %}
      <p class="error">{{ error }}</p>
    {% endif %}
    <form method="post" action="/events/{{ event.id }}/materials" class="form">
      <label>
        Nom du parent
        <input type="text" name="name" required />
      </label>
      <label>
        Type
        <select name="node_type">
          <option value="container">Sac / Conteneur</option>
          <option value="item">Équipement</option>
        </select>
      </label>
      <label>
        Quantité attendue (si équipement)
        <input type="number" name="expected_qty" min="0" />
      </label>
      <button class="btn" type="submit">Ajouter à la vérification</button>
    </form>
  </section>

  <section class="card">
    <div class="section-header">
      <div>
        <h2>Ajouter depuis le matériel existant</h2>
        <p class="muted">Choisissez un parent déjà créé dans le catalogue.</p>
      </div>
    </div>
    {% if error %}
      <p class="error">{{ error }}</p>
    {% endif %}
    <form method="post" action="/events/{{ event.id }}/materials/from-template" class="form">
      <label>
        Matériel
        <select name="template_id" required>
          <option value="">Sélectionner un matériel</option>
          {% for template in material_templates %}
            <option value="{{ template.id }}">
              {{ template.label }}{% if template.node_type == 'item' %} (Équipement){% else %} (Sac / Conteneur){% endif %}
            </option>
          {% endfor %}
        </select>
      </label>
      <button class="btn" type="submit">Ajouter depuis le catalogue</button>
    </form>
  </section>

  <section class="card event-checklist">
    <div class="section-header">
      <div>
        <h2>Matériel du poste</h2>
        <p class="muted">Supprimez un parent pour retirer tout son contenu.</p>
      </div>
    </div>
    <div class="status-grid status-grid--parents" aria-label="Parents du matériel">
      {% for parent in parent_cards %}
        {% set parent_status = parent.status or 'pending' %}
        <div class="status-card {{ parent_status }}">
          <div class="status-card-name">{{ parent.node.name }}</div>
          <div class="status-card-meta">
            <span class="status-card-pill {{ parent_status }}">
              {% if parent_status == 'ok' %}
                OK
              {% elif parent_status == 'problem' %}
                Problème
              {% else %}
                En attente
              {% endif %}
            </span>
            <form method="post" action="/events/{{ event.id }}/materials/{{ parent.node.id }}/delete">
              <button class="btn ghost" type="submit" onclick="return confirm('Supprimer ce parent et son contenu ?');">
                Supprimer
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
      {% if not parent_cards %}
        <p class="muted">Aucun parent ajouté pour le moment.</p>
      {% endif %}
    </div>
  </section>
</section>
{% endblock %}
