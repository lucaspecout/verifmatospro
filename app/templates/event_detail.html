{% extends "base.html" %}
{% block content %}
<section class="event-page">
  <header class="card event-hero">
    <div class="event-hero-top">
      <div>
        <p class="eyebrow">Poste de secours</p>
        <h1>{{ event.name }}</h1>
        <div class="event-meta">
          <span class="meta-pill">Date: {{ event.date_label }}</span>
          <span class="meta-pill {{ event_state_class }}">{{ event_state_label }}</span>
        </div>
      </div>
      <div class="actions event-actions">
        <button class="btn" type="button" data-action="copy-public">Copier le lien public</button>
        <a class="btn secondary" href="/events/{{ event.id }}/materials">Modifier le mat√©riel</a>
        <form method="post" action="/events/{{ event.id }}/close">
          <button class="btn ghost" type="submit">Fermer le poste</button>
        </form>
        <form method="post" action="/events/{{ event.id }}/delete">
          <button class="btn danger" type="submit" onclick="return confirm('Supprimer ce poste ?');">
            Supprimer
          </button>
        </form>
      </div>
    </div>

    {% set public_url = request.base_url ~ 'public/' ~ event.id ~ '/' ~ event.public_token %}
    <div class="event-public">
      <div class="event-public-text">
        <span class="label">Lien public</span>
        <span class="muted">Scanner le QR code pour ouvrir la checklist.</span>
      </div>
      <div class="event-public-qr">
        <img
          src="https://api.qrserver.com/v1/create-qr-code/?size=96x96&data={{ public_url | urlencode }}"
          alt="QR code du lien public"
          class="qr-code"
          loading="lazy"
        />
      </div>
      <span class="sr-only" id="public-link">{{ public_url }}</span>
    </div>

    {% if parent_tiles %}
      <div class="event-quick-overview">
        <div class="overview-header">
          <div>
            <h2>Vue rapide</h2>
            <p class="muted">Statut instantan√© des sacs principaux.</p>
          </div>
          <span class="section-chip">Couleurs statut</span>
        </div>
        <div class="status-grid status-grid--compact event-quick-grid" aria-label="Statut rapide du mat√©riel">
          {% for parent in parent_tiles %}
            {% set parent_status = parent.status or 'pending' %}
            <div
              class="status-square {{ parent_status }}{% if parent.node.loaded_at %} loaded{% endif %}"
              data-node-id="{{ parent.node.id }}"
              data-status="{{ parent_status }}"
            >
              <span class="status-square-name">{{ parent.node.name }}</span>
              <span class="status-square-status">
                {% if parent_status == 'ok' %}
                  OK
                {% elif parent_status == 'problem' %}
                  Probl√®me
                {% else %}
                  En attente
                {% endif %}
              </span>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="event-summary">
      <div class="summary-card">
        <div class="summary-header">
          <span>Progression globale</span>
          <span class="summary-value" id="event-progress-percent">{{ progress.percent }}%</span>
        </div>
        <div class="progress">
          <div class="progress-bar" id="event-progress-bar" style="width: {{ progress.percent }}%"></div>
        </div>
        <div class="stats modern" id="event-progress-stats">
          <span class="stat-pill ok">OK: {{ progress.ok }}</span>
          <span class="stat-pill problem">Probl√®mes: {{ progress.problem }}</span>
          <span class="stat-pill pending">En attente: {{ progress.pending }}</span>
        </div>
      </div>
    </div>
  </header>

  <section class="card event-checklist">
    <div class="section-header">
      <div>
        <h2>Checklist mat√©riel</h2>
        <p class="muted">Mise √† jour en direct d√®s qu'un v√©rificateur agit.</p>
      </div>
      <span class="section-chip">Live</span>
    </div>
    <div class="tree" id="event-checklist-tree">
      {% include "partials/event_detail_tree.html" %}
    </div>
  </section>
</section>

<div class="modal" id="load-modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="load-modal-title">
    <h2 id="load-modal-title" class="modal-title">Destination</h2>
    <p class="muted" id="load-modal-subtitle"></p>
    <form class="modal-form">
      <label>Nom du v√©hicule
        <input
          type="text"
          id="load-vehicle-name"
          name="vehicle_name"
          placeholder="Ex: V√©hicule 1"
          required
        />
      </label>
      <div class="modal-actions">
        <button class="btn secondary" type="button" data-action="cancel-load">Annuler</button>
        <button class="btn" type="submit">Confirmer</button>
      </div>
    </form>
  </div>
</div>

<script>
  const copyButton = document.querySelector('[data-action="copy-public"]');
  const linkEl = document.querySelector('#public-link');
  if (copyButton && linkEl) {
    copyButton.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(linkEl.textContent.trim());
        copyButton.textContent = 'Lien copi√©';
        setTimeout(() => {
          copyButton.textContent = 'Copier le lien public';
        }, 2000);
      } catch (err) {
        copyButton.textContent = 'Erreur';
        setTimeout(() => {
          copyButton.textContent = 'Copier le lien public';
        }, 2000);
      }
    });
  }

  const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${protocol}://${location.host}/ws/events/{{ event.id }}`);

  const statusLabels = {
    ok: 'OK',
    problem: 'Probl√®me',
    pending: 'En attente',
  };

  const updateProgress = (progress) => {
    const bar = document.querySelector('#event-progress-bar');
    if (bar) {
      bar.style.width = `${progress.percent}%`;
    }
    const percent = document.querySelector('#event-progress-percent');
    if (percent) {
      percent.textContent = `${progress.percent}%`;
    }
    const stats = document.querySelector('#event-progress-stats');
    if (stats) {
      stats.innerHTML = `
        <span class="stat-pill ok">OK: ${progress.ok}</span>
        <span class="stat-pill problem">Probl√®mes: ${progress.problem}</span>
        <span class="stat-pill pending">En attente: ${progress.pending}</span>
      `;
    }
  };

  const setNodeStatus = (node, status, comment, verifierName) => {
    node.dataset.status = status || 'pending';
    node.classList.remove('ok', 'problem', 'pending');
    if (status) {
      node.classList.add(status);
    }
    const badge = node.querySelector('[data-role="status"]');
    if (badge) {
      badge.textContent = statusLabels[status] || status;
      badge.classList.remove('ok', 'problem', 'pending');
      if (status) {
        badge.classList.add(status);
      }
    }
    const commentEl = node.querySelector('[data-role="comment"]');
    if (commentEl && typeof comment !== 'undefined') {
      commentEl.textContent = comment || 'Aucun commentaire.';
    }
    const verifierEl = node.querySelector('[data-role="verifier"]');
    if (verifierEl && typeof verifierName !== 'undefined') {
      verifierEl.textContent = verifierName ? `Derni√®re action: ${verifierName}` : 'Derni√®re action: Non renseign√©';
    }
    if (node.dataset.nodeType === 'container') {
      const chargeButton = node.querySelector('[data-action="charge-load"]');
      if (chargeButton) {
        const loaded = node.dataset.loaded === 'true';
        const isReady = status === 'ok' && !loaded;
        chargeButton.classList.toggle('is-ready', isReady);
        chargeButton.classList.toggle('is-loaded', loaded);
      }
    }
  };

  const refreshParentTiles = () => {
    const tiles = document.querySelectorAll(
      '.status-card[data-node-id], .status-square[data-node-id]',
    );
    tiles.forEach((tile) => {
      const nodeId = tile.dataset.nodeId;
      const node = document.querySelector(`.tree-node[data-node-id="${nodeId}"]`);
      if (!node) {
        return;
      }
      const status = node.dataset.status || 'pending';
      tile.classList.remove('ok', 'problem', 'pending');
      tile.classList.add(status);
      tile.dataset.status = status;
      const label = tile.querySelector('.status-square-status');
      if (label) {
        if (status === 'ok') {
          label.textContent = 'OK';
        } else if (status === 'problem') {
          label.textContent = 'Probl√®me';
        } else {
          label.textContent = 'En attente';
        }
      }
      tile.title = `${node.dataset.nodeName || node.querySelector('.tree-name')?.textContent?.trim() || 'Parent'} ‚Äî ${status}`;
    });
  };

  const updateContainerCounts = (containerNode) => {
    if (!containerNode) {
      return;
    }
    const children = containerNode.querySelectorAll(
      ':scope .tree-node.is-item, :scope .tree-node.is-container',
    );
    if (!children.length) {
      return;
    }
    const totals = { total: 0, ok: 0, problem: 0, pending: 0 };
    children.forEach((child) => {
      if (child.dataset.nodeType === 'item') {
        totals.total += 1;
        const status = child.dataset.status || 'pending';
        totals[status] += 1;
      }
    });
    const totalPill = containerNode.querySelector('.count-pill.neutral');
    if (totalPill) {
      totalPill.textContent = `Total ${totals.total}`;
    }
    const okPill = containerNode.querySelector('.count-pill.ok');
    if (okPill) {
      okPill.textContent = `OK ${totals.ok}`;
    }
    const problemPill = containerNode.querySelector('.count-pill.problem');
    if (problemPill) {
      problemPill.textContent = `Probl√®mes ${totals.problem}`;
    }
    const pendingPill = containerNode.querySelector('.count-pill.pending');
    if (pendingPill) {
      pendingPill.textContent = `En attente ${totals.pending}`;
    }
  };

  const recomputeContainerStatus = (containerId) => {
    if (!containerId || containerId === 'root') {
      return;
    }
    const container = document.querySelector(`[data-node-id="${containerId}"]`);
    if (!container) {
      return;
    }
    const children = document.querySelectorAll(`[data-parent-id="${containerId}"]`);
    const statuses = Array.from(children).map((child) => child.dataset.status || 'pending');
    let nextStatus = 'pending';
    if (statuses.every((status) => status === 'ok')) {
      nextStatus = 'ok';
    } else if (statuses.some((status) => status === 'problem')) {
      nextStatus = 'problem';
    }
    setNodeStatus(container, nextStatus);
    updateContainerCounts(container);
    recomputeContainerStatus(container.dataset.parentId);
  };

  const applyBulkOkToContainer = (containerNode, verifierName = '') => {
    if (!containerNode) {
      return;
    }
    containerNode.querySelectorAll('.tree-node.is-item').forEach((node) => {
      setNodeStatus(node, 'ok', '', verifierName);
    });
    recomputeContainerStatus(containerNode.dataset.nodeId);
    refreshParentTiles();
  };

  const applyOkFallback = (targetNode, verifierName = '') => {
    if (!targetNode) {
      return;
    }
    if (targetNode.dataset.nodeType === 'item') {
      setNodeStatus(targetNode, 'ok', '', verifierName);
      recomputeContainerStatus(targetNode.dataset.parentId);
      refreshParentTiles();
      return;
    }
    applyBulkOkToContainer(targetNode, verifierName);
  };

  document.querySelectorAll('.tree-node.is-container').forEach((node) => {
    node.removeAttribute('open');
  });

  const loadModal = document.querySelector('#load-modal');
  const loadForm = loadModal?.querySelector('.modal-form');
  const loadCancelButton = loadModal?.querySelector('[data-action="cancel-load"]');
  const loadVehicleInput = loadModal?.querySelector('#load-vehicle-name');
  const loadModalSubtitle = loadModal?.querySelector('#load-modal-subtitle');
  const loadState = new Map();
  let activeLoadNodeId = null;

  const syncLoadStateFromDom = () => {
    loadState.clear();
    document
      .querySelectorAll('.tree-node.is-container[data-load-vehicle]')
      .forEach((node) => {
        const vehicle = node.dataset.loadVehicle?.trim();
        const loaded = node.dataset.loaded === 'true';
        if (vehicle || loaded) {
          loadState.set(node.dataset.nodeId, { vehicle, loaded });
        }
      });
  };

  syncLoadStateFromDom();

  const closeLoadModal = () => {
    if (!loadModal) {
      return;
    }
    loadModal.classList.remove('is-open');
    loadModal.setAttribute('aria-hidden', 'true');
    activeLoadNodeId = null;
  };

  const openLoadModal = (nodeId, nodeName) => {
    if (!loadModal || !nodeId || !loadVehicleInput || !loadModalSubtitle) {
      return;
    }
    activeLoadNodeId = nodeId;
    loadModal.dataset.activeNodeId = nodeId;
    const currentInfo = loadState.get(nodeId);
    const resolvedName = nodeName?.trim() || 'Sac';
    loadModalSubtitle.textContent = `O√π le sac "${resolvedName}" a-t-il √©t√© charg√© ?`;
    loadVehicleInput.value = currentInfo?.vehicle || '';
    loadModal.classList.add('is-open');
    loadModal.setAttribute('aria-hidden', 'false');
    loadVehicleInput.focus();
  };

  window.openLoadModal = openLoadModal;

  const updateLoadDestination = (nodeId, vehicle, loaded = false) => {
    const value = vehicle?.trim();
    if (value || loaded) {
      loadState.set(nodeId, { vehicle: value, loaded });
    } else {
      loadState.delete(nodeId);
    }
    const treeNode = document.querySelector(`.tree-node.is-container[data-node-id="${nodeId}"]`);
    if (!treeNode) {
      return;
    }
    treeNode.dataset.loadVehicle = value || '';
    treeNode.dataset.loaded = loaded ? 'true' : 'false';
    treeNode.classList.toggle('loaded', loaded);
    const destination = treeNode.querySelector('[data-role="load-destination"]');
    const loadButton = treeNode.querySelector('[data-action="open-load-modal"]');
    const chargeButton = treeNode.querySelector('[data-action="charge-load"]');
    const loadStatus = treeNode.querySelector('[data-role="load-status"]');
    if (destination) {
      if (value) {
        destination.textContent = `Destination: ${value}`;
        destination.hidden = false;
      } else if (loaded) {
        destination.textContent = 'Charg√© dans v√©hicule non renseign√©';
        destination.hidden = false;
      } else {
        destination.hidden = true;
      }
    }
    if (loadButton) {
      loadButton.textContent = value ? 'Modifier' : 'Destination';
    }
    if (loadStatus) {
      loadStatus.hidden = !loaded;
    }
    if (chargeButton) {
      chargeButton.textContent = loaded ? '‚úÖ Charg√©' : 'üöö Charger';
      const disableCharge = loaded || treeNode.dataset.status !== 'ok';
      chargeButton.toggleAttribute('disabled', disableCharge);
      chargeButton.setAttribute('aria-disabled', disableCharge ? 'true' : 'false');
      chargeButton.classList.toggle('is-loaded', loaded);
      chargeButton.classList.toggle('is-ready', !disableCharge && !loaded);
    }
  };

  document.addEventListener('click', (event) => {
    const button = event.target.closest('[data-action="open-load-modal"]');
    if (!button) {
      return;
    }
    const container = button.closest('[data-node-id]');
    if (!container || button.hidden) {
      return;
    }
    const nodeName =
      container.querySelector('.tree-name')?.textContent?.trim() ||
      'Sac';
    openLoadModal(container.dataset.nodeId, nodeName);
  });

  const triggerBulkOk = (container) => {
    if (!container) {
      return;
    }
    const containerNode = document.querySelector(
      `.tree-node[data-node-id="${container.dataset.nodeId}"]`,
    );
    const targetNode = containerNode || container;
    fetch(`/events/{{ event.id }}/nodes/${container.dataset.nodeId}/bulk-ok`, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
      },
    })
      .then(async (response) => {
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        if (data.progress) {
          updateProgress(data.progress);
        }
        if (Array.isArray(data.updated_nodes) && data.updated_nodes.length > 0) {
          data.updated_nodes.forEach((nodeUpdate) => {
            const node = document.querySelector(`.tree-node[data-node-id="${nodeUpdate.id}"]`);
            if (node) {
              setNodeStatus(node, nodeUpdate.status, '', nodeUpdate.verifier_name || '');
              recomputeContainerStatus(node.dataset.parentId);
            }
          });
          refreshParentTiles();
        } else if (targetNode) {
          applyOkFallback(targetNode, data.verifier_name || '');
        }
        window.fetchLiveChecklist?.();
      })
      .catch(() => {
        applyOkFallback(targetNode, '');
        window.fetchLiveChecklist?.();
      });
  };

  document.addEventListener('submit', (event) => {
    const form = event.target.closest('form.inline-form[action*="/bulk-ok"]');
    if (!form) {
      return;
    }
    event.preventDefault();
    event.stopPropagation();
    const container = form.closest('[data-node-id]');
    triggerBulkOk(container);
  });

  document.addEventListener('click', (event) => {
    const button = event.target.closest('[data-action="bulk-ok"]');
    if (!button) {
      return;
    }
    event.preventDefault();
    event.stopPropagation();
    const container = button.closest('[data-node-id]');
    if (!container) {
      return;
    }
    triggerBulkOk(container);
  });

  document.addEventListener('click', (event) => {
    const button = event.target.closest('[data-action="charge-load"]');
    if (!button) {
      return;
    }
    event.preventDefault();
    event.stopPropagation();
    const container = button.closest('[data-node-id]');
    if (!container || button.hidden) {
      return;
    }
    const vehicle = container.dataset.loadVehicle?.trim() || '';
    const previousLabel = button.textContent;
    button.textContent = 'Chargement...';
    button.disabled = true;
    fetch(`/events/{{ event.id }}/nodes/${container.dataset.nodeId}/charge`, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
      },
    })
      .then(async (response) => {
        button.textContent = previousLabel;
        button.disabled = false;
        if (!response.ok) {
          let message = 'Impossible de charger ce sac pour le moment.';
          try {
            const errorPayload = await response.json();
            if (errorPayload?.detail) {
              message = errorPayload.detail;
            }
          } catch (err) {
            // Ignore parse errors
          }
          alert(message);
          return;
        }
        const data = await response.json();
        updateLoadDestination(String(data.node_id), data.vehicle || vehicle, Boolean(data.loaded));
      })
      .catch(() => {
        button.textContent = previousLabel;
        button.disabled = false;
        alert('Erreur r√©seau pendant le chargement.');
      });
  });

  loadCancelButton?.addEventListener('click', closeLoadModal);

  loadModal?.addEventListener('click', (event) => {
    if (event.target === loadModal) {
      closeLoadModal();
    }
  });

  loadForm?.addEventListener('submit', (event) => {
    event.preventDefault();
    const resolvedNodeId = activeLoadNodeId || loadModal?.dataset.activeNodeId;
    if (!resolvedNodeId || !loadVehicleInput) {
      return;
    }
    const vehicle = loadVehicleInput.value.trim();
    if (!vehicle) {
      loadVehicleInput.focus();
      return;
    }
    const payload = new FormData();
    payload.append('vehicle_name', vehicle);
    fetch(`/events/{{ event.id }}/nodes/${resolvedNodeId}/load`, {
      method: 'POST',
      body: payload,
      headers: {
        'Accept': 'application/json',
      },
    })
      .then(async (response) => {
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        updateLoadDestination(String(data.node_id), data.vehicle || vehicle, Boolean(data.loaded));
        closeLoadModal();
      })
      .catch(() => {});
  });

  const getOpenNodeIds = () =>
    Array.from(document.querySelectorAll('.tree-node.is-container[open]')).map((node) => node.dataset.nodeId);

  const restoreOpenNodes = (openIds) => {
    if (!openIds?.length) {
      return;
    }
    openIds.forEach((nodeId) => {
      const node = document.querySelector(`.tree-node.is-container[data-node-id="${nodeId}"]`);
      if (node) {
        node.setAttribute('open', '');
      }
    });
  };

  const applyLiveChecklist = (payload) => {
    const openNodeIds = getOpenNodeIds();
    const parentSummary = document.querySelector('#event-parent-summary');
    if (parentSummary && payload.parent_summary_html) {
      parentSummary.innerHTML = payload.parent_summary_html;
    }
    const tree = document.querySelector('#event-checklist-tree');
    if (tree && payload.tree_html) {
      tree.innerHTML = payload.tree_html;
    }
    if (payload.progress) {
      updateProgress(payload.progress);
    }
    restoreOpenNodes(openNodeIds);
    refreshParentTiles();
    syncLoadStateFromDom();
  };

  const fetchLiveChecklist = async () => {
    try {
      const response = await fetch(`/events/{{ event.id }}/live`, {
        headers: {
          'Accept': 'application/json',
        },
      });
      if (!response.ok) {
        return;
      }
      const payload = await response.json();
      applyLiveChecklist(payload);
    } catch (error) {
      // Ignore refresh failures to avoid noisy logs.
    }
  };

  window.fetchLiveChecklist = fetchLiveChecklist;

  fetchLiveChecklist();
  setInterval(fetchLiveChecklist, 10000);

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'progress') {
      updateProgress(data.progress);
      const node = document.querySelector(`[data-node-id="${data.node_id}"]`);
      if (node) {
        setNodeStatus(node, data.status, data.comment, data.verifier_name);
        recomputeContainerStatus(node.dataset.parentId);
      }
      refreshParentTiles();
    }
    if (data.type === 'load') {
      updateLoadDestination(String(data.node_id), data.vehicle || '', Boolean(data.loaded));
    }
  };
</script>
{% endblock %}
