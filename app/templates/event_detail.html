{% extends "base.html" %}
{% block content %}
<section class="event-page">
  <header class="card event-hero">
    <div class="event-hero-top">
      <div>
        <p class="eyebrow">Poste de secours</p>
        <h1>{{ event.name }}</h1>
        <div class="event-meta">
          <span class="meta-pill">Date: {{ event.date_label }}</span>
          <span class="meta-pill {{ event_state_class }}">{{ event_state_label }}</span>
        </div>
      </div>
      <div class="actions event-actions">
        <button class="btn" type="button" data-action="copy-public">Copier le lien public</button>
        <a class="btn secondary" href="/events/{{ event.id }}/materials">Modifier le matériel</a>
        <form method="post" action="/events/{{ event.id }}/close">
          <button class="btn ghost" type="submit">Fermer le poste</button>
        </form>
        <form method="post" action="/events/{{ event.id }}/delete">
          <button class="btn danger" type="submit" onclick="return confirm('Supprimer ce poste ?');">
            Supprimer
          </button>
        </form>
      </div>
    </div>

    {% set public_url = request.base_url ~ 'public/' ~ event.id ~ '/' ~ event.public_token %}
    <div class="event-public">
      <div class="event-public-text">
        <span class="label">Lien public</span>
        <span class="muted">Scanner le QR code pour ouvrir la checklist.</span>
      </div>
      <div class="event-public-qr">
        <img
          src="https://api.qrserver.com/v1/create-qr-code/?size=96x96&data={{ public_url | urlencode }}"
          alt="QR code du lien public"
          class="qr-code"
          loading="lazy"
        />
      </div>
      <span class="sr-only" id="public-link">{{ public_url }}</span>
    </div>

    <div class="event-summary">
      <div class="summary-card">
        <div class="summary-header">
          <span>Progression globale</span>
          <span class="summary-value" id="event-progress-percent">{{ progress.percent }}%</span>
        </div>
        <div class="progress">
          <div class="progress-bar" id="event-progress-bar" style="width: {{ progress.percent }}%"></div>
        </div>
        <div class="stats modern" id="event-progress-stats">
          <span class="stat-pill ok">OK: {{ progress.ok }}</span>
          <span class="stat-pill problem">Problèmes: {{ progress.problem }}</span>
          <span class="stat-pill pending">En attente: {{ progress.pending }}</span>
        </div>
      </div>
      <div class="summary-card" id="event-parent-summary">
        {% include "partials/event_detail_parent_summary.html" %}
      </div>
    </div>
  </header>

  <section class="card event-checklist">
    <div class="section-header">
      <div>
        <h2>Checklist matériel</h2>
        <p class="muted">Mise à jour en direct dès qu'un vérificateur agit.</p>
      </div>
      <span class="section-chip">Live</span>
    </div>
    <div class="tree" id="event-checklist-tree">
      {% include "partials/event_detail_tree.html" %}
    </div>
  </section>
</section>

<script>
  const copyButton = document.querySelector('[data-action="copy-public"]');
  const linkEl = document.querySelector('#public-link');
  if (copyButton && linkEl) {
    copyButton.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(linkEl.textContent.trim());
        copyButton.textContent = 'Lien copié';
        setTimeout(() => {
          copyButton.textContent = 'Copier le lien public';
        }, 2000);
      } catch (err) {
        copyButton.textContent = 'Erreur';
        setTimeout(() => {
          copyButton.textContent = 'Copier le lien public';
        }, 2000);
      }
    });
  }

  const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${protocol}://${location.host}/ws/events/{{ event.id }}`);

  const statusLabels = {
    ok: 'OK',
    problem: 'Problème',
    pending: 'En attente',
  };

  const updateProgress = (progress) => {
    const bar = document.querySelector('#event-progress-bar');
    if (bar) {
      bar.style.width = `${progress.percent}%`;
    }
    const percent = document.querySelector('#event-progress-percent');
    if (percent) {
      percent.textContent = `${progress.percent}%`;
    }
    const stats = document.querySelector('#event-progress-stats');
    if (stats) {
      stats.innerHTML = `
        <span class="stat-pill ok">OK: ${progress.ok}</span>
        <span class="stat-pill problem">Problèmes: ${progress.problem}</span>
        <span class="stat-pill pending">En attente: ${progress.pending}</span>
      `;
    }
  };

  const setNodeStatus = (node, status, comment, verifierName) => {
    node.dataset.status = status || 'pending';
    node.classList.remove('ok', 'problem', 'pending');
    if (status) {
      node.classList.add(status);
    }
    const badge = node.querySelector('[data-role="status"]');
    if (badge) {
      badge.textContent = statusLabels[status] || status;
      badge.classList.remove('ok', 'problem', 'pending');
      if (status) {
        badge.classList.add(status);
      }
    }
    const commentEl = node.querySelector('[data-role="comment"]');
    if (commentEl && typeof comment !== 'undefined') {
      commentEl.textContent = comment || 'Aucun commentaire.';
    }
    const verifierEl = node.querySelector('[data-role="verifier"]');
    if (verifierEl && typeof verifierName !== 'undefined') {
      verifierEl.textContent = verifierName ? `Dernière action: ${verifierName}` : 'Dernière action: Non renseigné';
    }
  };

  const refreshParentTiles = () => {
    document.querySelectorAll('.status-card[data-node-id]').forEach((tile) => {
      const nodeId = tile.dataset.nodeId;
      const node = document.querySelector(`.tree-node[data-node-id="${nodeId}"]`);
      if (!node) {
        return;
      }
      const status = node.dataset.status || 'pending';
      tile.classList.remove('ok', 'problem', 'pending');
      tile.classList.add(status);
      tile.title = `${node.dataset.nodeName || node.querySelector('.tree-name')?.textContent?.trim() || 'Parent'} — ${status}`;
    });
  };

  const recomputeContainerStatus = (containerId) => {
    if (!containerId || containerId === 'root') {
      return;
    }
    const container = document.querySelector(`[data-node-id="${containerId}"]`);
    if (!container) {
      return;
    }
    const children = document.querySelectorAll(`[data-parent-id="${containerId}"]`);
    const statuses = Array.from(children).map((child) => child.dataset.status || 'pending');
    let nextStatus = 'pending';
    if (statuses.every((status) => status === 'ok')) {
      nextStatus = 'ok';
    } else if (statuses.some((status) => status === 'problem')) {
      nextStatus = 'problem';
    }
    setNodeStatus(container, nextStatus);
    recomputeContainerStatus(container.dataset.parentId);
  };

  document.querySelectorAll('.tree-node.is-container').forEach((node) => {
    node.removeAttribute('open');
  });

  const getOpenNodeIds = () =>
    Array.from(document.querySelectorAll('.tree-node.is-container[open]')).map((node) => node.dataset.nodeId);

  const restoreOpenNodes = (openIds) => {
    if (!openIds?.length) {
      return;
    }
    openIds.forEach((nodeId) => {
      const node = document.querySelector(`.tree-node.is-container[data-node-id="${nodeId}"]`);
      if (node) {
        node.setAttribute('open', '');
      }
    });
  };

  const applyLiveChecklist = (payload) => {
    const openNodeIds = getOpenNodeIds();
    const parentSummary = document.querySelector('#event-parent-summary');
    if (parentSummary && payload.parent_summary_html) {
      parentSummary.innerHTML = payload.parent_summary_html;
    }
    const tree = document.querySelector('#event-checklist-tree');
    if (tree && payload.tree_html) {
      tree.innerHTML = payload.tree_html;
    }
    if (payload.progress) {
      updateProgress(payload.progress);
    }
    restoreOpenNodes(openNodeIds);
    refreshParentTiles();
  };

  const fetchLiveChecklist = async () => {
    try {
      const response = await fetch(`/events/{{ event.id }}/live`, {
        headers: {
          'Accept': 'application/json',
        },
      });
      if (!response.ok) {
        return;
      }
      const payload = await response.json();
      applyLiveChecklist(payload);
    } catch (error) {
      // Ignore refresh failures to avoid noisy logs.
    }
  };

  fetchLiveChecklist();
  setInterval(fetchLiveChecklist, 10000);

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'progress') {
      updateProgress(data.progress);
      const node = document.querySelector(`[data-node-id="${data.node_id}"]`);
      if (node) {
        setNodeStatus(node, data.status, data.comment, data.verifier_name);
        recomputeContainerStatus(node.dataset.parentId);
      }
      refreshParentTiles();
    }
  };
</script>
{% endblock %}
