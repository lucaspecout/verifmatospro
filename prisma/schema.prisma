generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  CHEF
  MATERIEL
}

enum EventStatus {
  DRAFT
  ACTIVE
  DONE
}

enum LocationType {
  WAREHOUSE
  VEHICLE
  BAG
  COMPARTMENT
}

enum BagLocationType {
  VEHICLE
  WAREHOUSE
}

enum VerificationStatus {
  PENDING
  OK
  MISSING
}

model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  passwordHash        String
  role                Role
  isActive            Boolean  @default(true)
  forcePasswordChange Boolean  @default(false)
  createdAt           DateTime @default(now())
  events              Event[]
}

model Vehicle {
  id        String  @id @default(uuid())
  name      String
  type      String
  identifier String
  isActive  Boolean @default(true)
  bags      Bag[]
}

model Bag {
  id           String          @id @default(uuid())
  name         String
  code         String
  vehicleId    String?
  locationType BagLocationType
  createdAt    DateTime        @default(now())
  vehicle      Vehicle?        @relation(fields: [vehicleId], references: [id])
  compartments Compartment[]
}

model Compartment {
  id     String @id @default(uuid())
  bagId  String
  name   String
  order  Int
  bag    Bag    @relation(fields: [bagId], references: [id])
}

model ItemCatalog {
  id                             String @id @default(uuid())
  name                           String
  category                       String
  unit                           String?
  description                    String?
  isConsumable                   Boolean
  isElectronic                   Boolean
  defaultRequiresExpiryCheck     Boolean
  defaultRequiresFunctionalCheck Boolean
  stockEntries                   StockEntry[]
}

model StockEntry {
  id            String       @id @default(uuid())
  itemCatalogId String
  locationType  LocationType
  vehicleId     String?
  bagId         String?
  compartmentId String?
  theoreticalQty Int
  itemCatalog   ItemCatalog  @relation(fields: [itemCatalogId], references: [id])
}

model Template {
  id          String            @id @default(uuid())
  name        String            @unique
  description String?
  versionDate String
  createdAt   DateTime          @default(now())
  sections    TemplateSection[]
}

model TemplateSection {
  id         String         @id @default(uuid())
  templateId String
  name       String
  order      Int
  visualHint String?
  template   Template       @relation(fields: [templateId], references: [id], onDelete: Cascade)
  items      TemplateItem[]
}

model TemplateItem {
  id                      String   @id @default(uuid())
  sectionId               String
  label                   String
  expectedQuantity        Int
  unit                    String?
  requiresExpiryCheck     Boolean
  requiresFunctionalCheck Boolean
  isElectronic            Boolean
  isConsumable            Boolean
  order                   Int
  section                 TemplateSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
}

model Event {
  id              String                 @id @default(uuid())
  title           String
  description     String?
  createdByUserId String
  status          EventStatus            @default(DRAFT)
  publicSlug      String                 @unique
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  creator         User                   @relation(fields: [createdByUserId], references: [id])
  checklistSections EventChecklistSection[]
}

model EventChecklistSection {
  id      String               @id @default(uuid())
  eventId String
  name    String
  order   Int
  event   Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  items   EventChecklistItem[]
}

model EventChecklistItem {
  id                      String   @id @default(uuid())
  sectionId               String
  itemCatalogId           String?
  label                   String
  expectedQuantity        Int
  unit                    String?
  order                   Int
  requiresExpiryCheck     Boolean
  requiresFunctionalCheck Boolean
  section                 EventChecklistSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  verificationLine        VerificationLine?
}

model VerificationLine {
  id                  String            @id @default(uuid())
  eventChecklistItemId String           @unique
  status              VerificationStatus @default(PENDING)
  comment             String?
  checkedAt           DateTime?
  checkedByLabel      String?
  updatedAt           DateTime          @updatedAt
  eventChecklistItem  EventChecklistItem @relation(fields: [eventChecklistItemId], references: [id], onDelete: Cascade)
}
